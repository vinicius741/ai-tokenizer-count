---
phase: 03-cli-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/progress.ts
  - src/cli/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User sees progress bar during EPUB processing"
    - "Progress bar shows current file and percentage complete"
    - "Progress bar completes when file processing finishes"
    - "No progress bar output contamination from other console.log/error calls"
  artifacts:
    - path: "src/cli/progress.ts"
      provides: "Progress bar management with cli-progress MultiBar"
      min_lines: 40
      exports: ["createProgressBars", "updateProgress", "stopProgress"]
    - path: "src/cli/index.ts"
      provides: "CLI integration with progress updates"
      contains: "import.*progress"
  key_links:
    - from: "src/cli/index.ts"
      to: "src/cli/progress.ts"
      via: "import { createProgressBars, updateProgress, stopProgress }"
      pattern: "import.*from.*progress"
    - from: "src/cli/index.ts"
      to: "cli-progress"
      via: "MultiBar creation and management"
      pattern: "new MultiBar|multibar\\.(create|update|stop)"
---

<objective>
Implement progress indicators using cli-progress MultiBar to show real-time processing status during EPUB batch operations.

Purpose: Professional CLI experience requires visible progress feedback during long-running operations. Users should see which file is being processed and how much progress has been made.

Output: Working progress bar system with individual bars for each EPUB file, showing filename and percentage complete.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cli-polish/03-RESEARCH.md
@.planning/phases/03-cli-polish/03-CONTEXT.md

# Codebase context
@src/cli/index.ts
@src/errors/handler.ts
@src/output/table.ts
</context>

<tasks>

<task type="auto">
  <name>Install cli-progress dependency</name>
  <files>package.json</files>
  <action>
    Install cli-progress package:

    ```bash
    npm install cli-progress
    ```

    Use version 3.12.0 (current stable). This package provides MultiBar support for displaying multiple progress bars simultaneously (needed for parallel processing in plan 03-03).
  </action>
  <verify>Check package.json has "cli-progress" in dependencies</verify>
  <done>cli-progress installed and available</done>
</task>

<task type="auto">
  <name>Create progress bar management module</name>
  <files>src/cli/progress.ts</files>
  <action>
    Create src/cli/progress.ts with progress bar management functions using cli-progress MultiBar:

    **Requirements:**
    - Use cli-progress MultiBar (not single Preset)
    - Format: " {bar} | {filename} | {value}/{total}"
    - FPS: 10 (default)
    - Clear on complete: false (keep completed bars visible)
    - Hide cursor: true

    **Functions to export:**
    1. `createProgressBars(): MultiBar` - Create and return MultiBar instance
    2. `createBar(multiBar: MultiBar, filename: string, total: number): Bar` - Create individual bar for a file
    3. `updateProgress(bar: Bar, current: number): void` - Update bar progress
    4. `stopAll(multiBar: MultiBar): void` - Stop all bars and restore cursor

    **Code structure:**
    ```typescript
    import cliProgress from 'cli-progress';

    export function createProgressBars(): cliProgress.MultiBar {
      return new cliProgress.MultiBar({
        clearOnComplete: false,
        hideCursor: true,
        format: ' {bar} | {filename} | {value}/{total}',
        fps: 10,
        stream: process.stdout
      }, cliProgress.Presets.shades_grey);
    }

    export function createBar(multiBar: cliProgress.MultiBar, filename: string, total: number = 100): cliProgress.Bar {
      return multiBar.create(total, 0, { filename });
    }

    export function updateProgress(bar: cliProgress.Bar, current: number): void {
      bar.update(current);
    }

    export function stopAll(multiBar: cliProgress.MultiBar): void {
      multiBar.stop();
    }
    ```

    **Important:** Use dynamic bar creation (bars created as jobs start, not all upfront). This is critical for parallel processing in plan 03-03.
  </action>
  <verify>Check that:
  - src/cli/progress.ts exists
  - Exports createProgressBars, createBar, updateProgress, stopAll
  - Uses cli-progress MultiBar (not single bar)
  - Format includes {filename} and {value}/{total}
  </verify>
  <done>Progress module created with MultiBar support</done>
</task>

<task type="auto">
  <name>Integrate progress bars into CLI processing loop</name>
  <files>src/cli/index.ts</files>
  <action>
    Modify src/cli/index.ts to integrate progress bars into the processing loop:

    **Changes needed:**

    1. Import progress functions:
    ```typescript
    import { createProgressBars, createBar, updateProgress, stopAll } from './progress.js';
    ```

    2. In processEpubs function, create MultiBar before processing:
    ```typescript
    const multibar = createProgressBars();
    ```

    3. Create progress bar for each file in the processing loop. Reference existing loop in processEpubsWithErrors (src/errors/handler.ts lines 152-243).

    **Critical decision:** Where to integrate progress updates?
    - Option A: Modify processEpubsWithErrors to accept progress callbacks
    - Option B: Wrap processEpubsWithErrors with progress tracking at CLI level

    **Choose Option B** - Keep errors/handler.ts independent (testable), add progress tracking at CLI level only.

    **Implementation for Option B:**
    ```typescript
    // In processEpubs function, replace processEpubsWithErrors call
    const multibar = createProgressBars();
    const bars = new Map<string, cliProgress.Bar>();

    // Create bars for all files upfront (sequential processing)
    for (const file of allFiles) {
      const filename = path.basename(file);
      bars.set(filename, createBar(multibar, filename));
    }

    // Process with progress updates
    let processed = 0;
    for (const file of allFiles) {
      const filename = path.basename(file);
      const bar = bars.get(filename);

      // Update to 50% (parsing)
      if (bar) updateProgress(bar, 50);

      // Process file
      await processEpubsWithErrors([file], ...);

      // Update to 100% (complete)
      if (bar) updateProgress(bar, 100);

      processed++;
    }

    // Stop all bars
    stopAll(multibar);
    ```

    **Note:** This is sequential progress display. Parallel processing with individual bars will be added in plan 03-03.

    4. Ensure any error logging uses multibar.log() instead of console.error() during progress bar operation (avoid output contamination). See RESEARCH.md Pitfall 1.
  </action>
  <verify>Check that:
  - CLI creates MultiBar before processing
  - Individual bars created for each file
  - Progress updates happen during processing (50% at parsing, 100% at complete)
  - MultiBar.stop() called after all processing complete
  - Error logging uses multibar.log() or stops bars before console.error
  </verify>
  <done>Progress bars show during EPUB processing</done>
</task>

</tasks>

<verification>
1. Run epub-counter on test EPUB files
2. Verify progress bar appears and shows filename
3. Verify progress updates (0% -> 50% -> 100%)
4. Verify cursor is restored after processing completes
5. Verify no output contamination (errors appear above bars, not intermixed)

Test command:
```bash
npm link  # if needed
epub-counter ./epubs/
```

Expected output:
- Progress bars appear for each EPUB file
- Each bar shows filename and progress
- Bars complete at 100%
- Cursor restored, clean terminal state
</verification>

<success_criteria>
- User sees progress bar during EPUB processing with filename and percentage
- Progress bar completes at 100% for each file
- Terminal cursor properly restored after processing
- No console output contamination during progress bar operation
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-polish/03-01-SUMMARY.md`
</output>
