---
phase: 05-backend-api-file-processing
plan: 04
type: execute
wave: 3
depends_on: [05-02]
files_modified:
  - server/src/routes/sse.ts
  - server/src/lib/job-queue.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - User can GET /api/sse/:jobId and receive Server-Sent Events stream
    - SSE stream sends progress updates during processing (current/total EPUBs, percent)
    - SSE stream sends 'completed' event with results when job finishes
    - SSE stream sends 'error' event if job fails
    - Client disconnect doesn't stop processing (continues to completion)
  artifacts:
    - path: "server/src/routes/sse.ts"
      provides: "GET /api/sse/:jobId endpoint"
      exports: ["sseHandler"]
    - path: "server/src/lib/job-queue.ts"
      provides: "Progress callback mechanism for SSE"
      contains: "setProgressCallback, notifyProgress"
  key_links:
    - from: "server/src/routes/sse.ts"
      to: "server/src/lib/job-queue.ts"
      via: "register SSE callback with job queue"
      pattern: "setProgressCallback|jobQueue\.on"
    - from: "server/src/lib/job-queue.ts"
      to: "server/src/routes/sse.ts"
      via: "send progress events to client"
      pattern: "SSE|event: progress"
    - from: "server/src/routes/sse.ts"
      to: "server/src/lib/job-queue.ts"
      via: "query job status on connection"
      pattern: "getStatus|jobQueue\.getStatus"
---

<objective>
Implement Server-Sent Events (SSE) endpoint for real-time EPUB processing progress

Purpose: Provide live progress updates to frontend during long-running EPUB processing
Output: Working SSE endpoint that streams progress, completion, and error events
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/05-backend-api-file-processing/05-CONTEXT.md
@.planning/phases/05-backend-api-file-processing/05-02-PLAN.md
@server/src/server.ts
@server/src/lib/job-queue.ts
@packages/shared/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progress callback to JobQueue</name>
  <files>server/src/lib/job-queue.ts</files>
  <action>
    Extend JobQueue class in server/src/lib/job-queue.ts with SSE support:

    1. **Add progress callback registration:**
       ```typescript
       private progressCallbacks: Map<string, (progress: EpubProgress) => void> = new Map();

       setProgressCallback(jobId: string, callback: (progress: EpubProgress) => void): void {
         this.progressCallbacks.set(jobId, callback);
       }

       removeProgressCallback(jobId: string): void {
         this.progressCallbacks.delete(jobId);
       }

       private notifyProgress(jobId: string, progress: EpubProgress): void {
         const callback = this.progressCallbacks.get(jobId);
         if (callback) {
           try {
             callback(progress);
           } catch (err) {
             this.logger?.warn(`Progress callback failed for job ${jobId}:`, err);
           }
         }
       }
       ```

    2. **Integrate with EPUB processing** in processNext():
       - During EPUB iteration, call notifyProgress() with:
         ```typescript
         {
           fileName: basename(epubPath),
           current: index + 1,
           total: totalEpubs,
           percent: Math.round(((index + 1) / totalEpubs) * 100)
         }
       ```
       - Call after each EPUB completes processing

    3. **Handle job completion** with callbacks:
       - On completion: notify with final progress (percent: 100), then remove callback
       - On failure: notify with error, then remove callback
       - On cancellation: notify with cancelled status, then remove callback

    This allows SSE handler to register a callback that's called during processing.
  </action>
  <verify>grep -q "setProgressCallback\|notifyProgress" server/src/lib/job-queue.ts</verify>
  <done>JobQueue supports progress callbacks for SSE streaming</done>
</task>

<task type="auto">
  <name>Task 2: Create SSE endpoint</name>
  <files>server/src/routes/sse.ts</files>
  <action>
    Create server/src/routes/sse.ts with:

    1. **Import** dependencies:
       - Fastify from 'fastify'
       - JobState, JobStatus from @epub-counter/shared
       - jobQueue from ../lib/job-queue.js

    2. **Create sseHandler async function** that:
       - Registers GET /api/sse/:jobId route
       - Validates jobId exists in queue
         * If not found, return 404 with error
       - Sets SSE headers:
         ```typescript
         reply.header('Content-Type', 'text/event-stream');
         reply.header('Cache-Control', 'no-cache');
         reply.header('Connection', 'keep-alive');
         reply.header('X-Accel-Buffering', 'no'); // Disable nginx buffering
         ```
       - Gets current job status from jobQueue.getStatus()
       - Sends initial event with current state:
         ```typescript
         if (status === 'queued') {
           reply.sse({ id: '0', event: 'queued', data: { status: 'queued' } });
         } else if (status === 'processing') {
           reply.sse({ id: '0', event: 'progress', data: jobState.progress });
         }
         ```
       - Registers progress callback for streaming updates:
         ```typescript
         jobQueue.setProgressCallback(jobId, (progress) => {
           reply.sse({ event: 'progress', data: progress });
         });
         ```
       - Listens for client disconnect:
         ```typescript
         req.raw.on('close', () => {
           jobQueue.removeProgressCallback(jobId);
         });
         ```
       - Handles already completed jobs:
         * If status is 'completed', send final results and close
         * If status is 'failed', send error and close
         * If status is 'cancelled', send cancellation and close

    3. **SSE event format:**
       ```typescript
       // Progress event during processing:
       event: progress
       data: {"fileName":"book.epub","current":5,"total":10,"percent":50}

       // Completion event:
       event: completed
       data: { ...ResultsOutput }

       // Error event:
       event: error
       data: {"code":"EPUB_PARSE_ERROR","message":"Failed to parse EPUB"}

       // Queued event:
       event: queued
       data: {"status":"queued","position":1}
       ```

    Use Fastify's reply.sse() helper or write raw SSE format:
    ```typescript
    reply.raw.write(`event: ${event}\ndata: ${JSON.stringify(data)}\n\n`);
    ```

    Store reply.raw reference to send events after initial response.
  </action>
  <verify>grep -q "'/api/sse'\|sseHandler" server/src/routes/sse.ts && grep -q "reply\.raw" server/src/routes/sse.ts</verify>
  <done>GET /api/sse/:jobId endpoint streams progress events with reply.raw stored for async writes</done>
</task>

<task type="auto">
  <name>Task 3: Register SSE route in server</name>
  <files>server/src/server.ts</files>
  <action>
    Import and register the SSE route in server/src/server.ts:

    ```typescript
    import { sseHandler } from './routes/sse.js'

    // After process registration:
    await fastify.register(sseHandler)
    ```

    Ensure the route is registered after other API routes.
  </action>
  <verify>grep -q "sseHandler\|routes/sse" server/src/server.ts</verify>
  <done>/api/sse/:jobId endpoint is registered in Fastify server</done>
</task>

</tasks>

<verification>
1. Start server: npm run dev:server
2. Create a processing job:
   ```bash
   JOB_ID=$(curl -s -X POST http://localhost:8787/api/process \
     -H "Content-Type: application/json" \
     -d '{"path":"./epubs","tokenizers":["gpt4"]}' | jq -r '.jobId')
   echo "Job ID: $JOB_ID"
   ```
3. Test SSE connection:
   ```bash
   curl -N http://localhost:8787/api/sse/$JOB_ID
   ```
   Should output SSE events like:
   ```
   event: progress
   data: {"fileName":"book1.epub","current":1,"total":5,"percent":20}

   event: progress
   data: {"fileName":"book2.epub","current":2,"total":5,"percent":40}

   event: completed
   data: {"schemaVersion":"1.0",...}
   ```
4. Test invalid jobId:
   ```bash
   curl -i http://localhost:8787/api/sse/invalid-job-id
   ```
   Should return 404
5. Test client disconnect:
   - Start SSE connection, then Ctrl+C to disconnect
   - Verify job continues processing (check job status)
6. Verify reply.raw storage: grep -q "reply\.raw\|req\.raw" server/src/routes/sse.ts
</verification>

<success_criteria>
- GET /api/sse/:jobId returns 200 and sets SSE headers (Content-Type: text/event-stream)
- Queued jobs send 'queued' event immediately
- Processing jobs send current progress and stream updates
- Completed jobs send 'completed' event with full results
- Failed jobs send 'error' event with error details
- Client disconnect removes progress callback but doesn't stop job
- Invalid jobIds return 404
- SSE events are properly formatted (event: and data: lines)
- reply.raw reference is stored for async event writes
</success_criteria>

<output>
After completion, create `.planning/phases/05-backend-api-file-processing/05-04-SUMMARY.md`
</output>
