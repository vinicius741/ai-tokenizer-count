---
phase: 05-backend-api-file-processing
plan: 03
type: execute
wave: 3
depends_on: [05-02]
files_modified:
  - server/src/routes/process.ts
  - server/src/lib/path-validator.ts
  - server/src/server.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - User can POST to /api/process with {path, tokenizers, recursive?, maxMb?} body
    - Server responds immediately with {jobId} in < 100ms
    - Job is queued and starts processing asynchronously
    - Invalid path returns 400 error with clear message
  artifacts:
    - path: "server/src/routes/process.ts"
      provides: "POST /api/process endpoint"
      exports: ["processHandler"]
    - path: "server/src/lib/path-validator.ts"
      provides: "Path validation utilities"
      exports: ["validatePath", "isPathTraversal"]
  key_links:
    - from: "server/src/routes/process.ts"
      to: "server/src/lib/job-queue.ts"
      via: "enqueue job into queue"
      pattern: "jobQueue\.enqueue"
    - from: "server/src/routes/process.ts"
      to: "server/src/lib/path-validator.ts"
      via: "validate path before processing"
      pattern: "validatePath|isPathTraversal"
    - from: "server/src/lib/path-validator.ts"
      to: "server/src/routes/process.ts"
      via: "return error if path traversal detected"
      pattern: "400.*path traversal|INVALID_PATH"
---

<objective>
Implement POST /api/process endpoint that accepts EPUB folder path and tokenizers, queues processing job, returns job ID immediately

Purpose: Start asynchronous EPUB processing without blocking HTTP response
Output: Working API endpoint that queues jobs and returns jobId
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/05-backend-api-file-processing/05-CONTEXT.md
@.planning/phases/05-backend-api-file-processing/05-02-PLAN.md
@server/src/server.ts
@server/src/lib/job-queue.ts
@packages/shared/src/types.ts
@src/file-discovery/scanner.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create path validation utility</name>
  <files>server/src/lib/path-validator.ts</files>
  <action>
    Create server/src/lib/path-validator.ts with:

    1. **isPathTraversal(path)** - detects path traversal attempts
       ```typescript
       export function isPathTraversal(path: string): boolean {
         const normalized = path.replace(/\\/g, '/');
         return normalized.includes('..') ||
                normalized.startsWith('/') ||
                normalized.includes('~');
       }
       ```

    2. **validatePath(path)** - validates and resolves path
       ```typescript
       import fs from 'fs/promises';
       import path from 'path';

       export async function validatePath(inputPath: string): Promise<{valid: boolean, error?: string, resolvedPath?: string}> {
         // Check for path traversal
         if (isPathTraversal(inputPath)) {
           return { valid: false, error: 'Path traversal detected' };
         }

         // Resolve relative to current working directory
         const resolved = path.resolve(process.cwd(), inputPath);

         // Check if path exists
         try {
           const stats = await fs.stat(resolved);
           if (!stats.isDirectory() && !stats.isFile()) {
             return { valid: false, error: 'Path must be a file or directory' };
           }
           return { valid: true, resolvedPath: resolved };
         } catch {
           return { valid: false, error: 'Path does not exist' };
         }
       }
       ```

    This prevents path traversal attacks (../../etc/passwd) and ensures the path exists.
  </action>
  <verify>grep -q "isPathTraversal\|validatePath" server/src/lib/path-validator.ts</verify>
  <done>Path validation utility exists with traversal detection and existence checks</done>
</task>

<task type="auto">
  <name>Task 2: Create /api/process endpoint</name>
  <files>server/src/routes/process.ts</files>
  <action>
    Create server/src/routes/process.ts with:

    1. **Import** dependencies:
       - ProcessRequest from @epub-counter/shared
       - jobQueue from ../lib/job-queue.js
       - validatePath from ../lib/path-validator.js
       - ResultsOutput type from shared

    2. **Define request/response types:**
       ```typescript
       interface ProcessResponse {
         jobId: string;
         status: 'queued';
       }

       interface ProcessErrorResponse {
         error: {
           code: string;
           message: string;
           details?: string;
         };
       }
       ```

    3. **Create processHandler async function** that:
       - Registers POST /api/process route
       - Validates request body:
         * Required fields: path (string), tokenizers (array of strings)
         * Optional fields: recursive (boolean), maxMb (number)
       - Validates path using validatePath()
         * If invalid, return 400 with error code 'INVALID_PATH'
       - Validates tokenizers array is not empty
         * If empty, return 400 with error code 'INVALID_TOKENIZERS'
       - Calls jobQueue.enqueue() with ProcessRequest
       - Returns 201 with {jobId, status: 'queued'}

    4. **Use Fastify schema validation** (optional but recommended):
       ```typescript
       fastify.post('/api/process', {
         schema: {
           body: {
             type: 'object',
             required: ['path', 'tokenizers'],
             properties: {
               path: { type: 'string' },
               tokenizers: { type: 'array', items: { type: 'string' }, minItems: 1 },
               recursive: { type: 'boolean' },
               maxMb: { type: 'number' }
             }
           }
         }
       }, async (request, reply) => {
         // Handler logic
       });
       ```

    Error codes to use:
    - 'INVALID_PATH': Path traversal, doesn't exist, or not a file/directory
    - 'INVALID_TOKENIZERS': Tokenizers array is empty
    - 'INVALID_REQUEST': Missing required fields

    Return errors in format: `{ error: { code, message, details? } }`
  </action>
  <verify>grep -q "'/api/process'\|processHandler" server/src/routes/process.ts</verify>
  <done>POST /api/process endpoint exists with validation and job queuing</done>
</task>

<task type="auto">
  <name>Task 3: Register process route in server</name>
  <files>server/src/server.ts</files>
  <action>
    Import and register the process route in server/src/server.ts:

    ```typescript
    import { processHandler } from './routes/process.js'

    // After list-models registration:
    await fastify.register(processHandler)
    ```

    Ensure the route is registered after CORS and list-models.
  </action>
  <verify>grep -q "processHandler\|routes/process" server/src/server.ts</verify>
  <done>/api/process endpoint is registered in Fastify server</done>
</task>

</tasks>

<verification>
1. Start server: npm run dev:server
2. Test valid request:
   ```bash
   curl -X POST http://localhost:8787/api/process \
     -H "Content-Type: application/json" \
     -d '{"path":"./epubs","tokenizers":["gpt4","claude"]}'
   ```
   Should return: `{"jobId":"job-...","status":"queued"}`
3. Test path traversal:
   ```bash
   curl -X POST http://localhost:8787/api/process \
     -H "Content-Type: application/json" \
     -d '{"path":"../../etc/passwd","tokenizers":["gpt4"]}'
   ```
   Should return 400 with error code 'INVALID_PATH'
4. Test empty tokenizers:
   ```bash
   curl -X POST http://localhost:8787/api/process \
     -H "Content-Type: application/json" \
     -d '{"path":"./epubs","tokenizers":[]}'
   ```
   Should return 400 with error code 'INVALID_TOKENIZERS'
5. Test missing fields:
   ```bash
   curl -X POST http://localhost:8787/api/process \
     -H "Content-Type: application/json" \
     -d '{"path":"./epubs"}'
   ```
   Should return 400
</verification>

<success_criteria>
- POST /api/process returns 201 with {jobId, status: 'queued'} for valid requests
- Path traversal attempts return 400 with error code 'INVALID_PATH'
- Empty tokenizers array returns 400 with error code 'INVALID_TOKENIZERS'
- Missing required fields return 400 with error code 'INVALID_REQUEST'
- Response time < 100ms (job is queued, not processed immediately)
- Job is added to jobQueue and can be queried by jobId
</success_criteria>

<output>
After completion, create `.planning/phases/05-backend-api-file-processing/05-03-SUMMARY.md`
</output>
