---
phase: 05-backend-api-file-processing
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - server/src/lib/job-queue.ts
  - server/src/lib/job-types.ts
  - packages/shared/src/types.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - Server can queue EPUB processing jobs with unique job IDs
    - Jobs are processed one at a time (sequential processing)
    - Job status can be queried by job ID
    - Job results are stored and retrievable after completion
    - Completed jobs include per-EPUB results and summary statistics
  artifacts:
    - path: "server/src/lib/job-queue.ts"
      provides: "In-memory job queue implementation"
      exports: ["JobQueue", "enqueue", "getStatus", "cancel"]
    - path: "server/src/lib/job-types.ts"
      provides: "Job-related type definitions"
      contains: "type JobStatus, type JobState, interface ProcessingJob"
    - path: "packages/shared/src/types.ts"
      provides: "Shared types for API contracts"
      contains: "type JobStatus, interface JobState"
  key_links:
    - from: "server/src/lib/job-queue.ts"
      to: "src/epub/parser.ts"
      via: "reuse existing EPUB processing logic"
      pattern: "processEpub|parseEpub"
    - from: "server/src/lib/job-queue.ts"
      to: "src/tokenizers/index.ts"
      via: "reuse tokenizer registry for counting"
      pattern: "createTokenizer|Tokenizer"
    - from: "server/src/lib/job-types.ts"
      to: "packages/shared/src/types.ts"
      via: "export shared types for frontend"
      pattern: "JobStatus|JobState"
---

<objective>
Implement in-memory background job queue for EPUB processing with job status tracking

Purpose: Enable long-running EPUB processing without blocking API responses, support SSE progress updates
Output: Working JobQueue class with enqueue, status query, and cancellation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/05-backend-api-file-processing/05-CONTEXT.md
@.planning/phases/04-foundation-project-setup/04-03-SUMMARY.md
@server/src/server.ts
@packages/shared/src/types.ts
@src/errors/handler.ts
@src/file-discovery/scanner.ts
@src/cli/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define job-related types in shared package</name>
  <files>packages/shared/src/types.ts</files>
  <action>
    Add job-related types to packages/shared/src/types.ts:

    ```typescript
    /**
     * Job status in the processing queue
     */
    export type JobStatus = 'queued' | 'processing' | 'completed' | 'failed' | 'cancelled';

    /**
     * Processing progress for a single EPUB
     */
    export interface EpubProgress {
      /** File name being processed */
      fileName: string;
      /** Current EPUB index (1-based) */
      current: number;
      /** Total EPUBs to process */
      total: number;
      /** Percent complete (0-100) */
      percent: number;
      /** Error if this EPUB failed */
      error?: string;
    }

    /**
     * Job state for status queries
     */
    export interface JobState {
      /** Unique job identifier */
      jobId: string;
      /** Current job status */
      status: JobStatus;
      /** Processing progress (only during 'processing' status) */
      progress?: EpubProgress;
      /** Completed results (only when status is 'completed') */
      results?: ResultsOutput;
      /** Error message (only when status is 'failed') */
      error?: string;
      /** Job creation timestamp */
      createdAt: string;
      /** Job completion timestamp (if completed/failed/cancelled) */
      completedAt?: string;
    }
    ```

    Also add ProcessRequest type for API input:

    ```typescript
    /**
     * Request body for starting EPUB processing
     */
    export interface ProcessRequest {
      /** EPUB folder path on server */
      path: string;
      /** Tokenizers to use */
      tokenizers: TokenizerType[];
      /** Include subdirectories */
      recursive?: boolean;
      /** Max EPUB text size in MB */
      maxMb?: number;
    }
    ```
  </action>
  <verify>grep -q "type JobStatus\|interface JobState\|interface ProcessRequest" packages/shared/src/types.ts</verify>
  <done>JobStatus, JobState, EpubProgress, and ProcessRequest types are exported from @epub-counter/shared</done>
</task>

<task type="auto">
  <name>Task 2: Create in-memory job queue implementation</name>
  <files>server/src/lib/job-queue.ts</files>
  <action>
    Create server/src/lib/job-queue.ts with:

    1. **JobQueue class** with:
       - `private jobs: Map<string, ProcessingJob>` - in-memory job storage
       - `private queue: string[]` - FIFO queue of job IDs
       - `private currentJob: string | null` - currently processing job ID
       - `private isProcessing: boolean` - whether processor is running

    2. **ProcessingJob interface** (local, not shared):
       ```typescript
       interface ProcessingJob extends Omit<JobState, 'jobId'> {
         id: string;
         resolve?: (value: JobState) => void;
         onProgress?: (progress: EpubProgress) => void;
       }
       ```

    3. **enqueue(method)** - creates job, adds to queue, returns jobId
       - Generate unique jobId: `job-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`
       - Set status to 'queued', createdAt to now
       - Start processing loop if not running

    4. **processNext()** - processes jobs sequentially
       - If no jobs in queue or isProcessing, return
       - Dequeue next job, set status to 'processing'
       - Call processEpubs() with job parameters
       - On success: set status to 'completed', store results
       - On failure: set status to 'failed', store error
       - Call processNext() to continue queue

    5. **getStatus(jobId)** - returns JobState or null
       - Look up job by ID
       - Return shallow copy with jobId and progress/results

    6. **cancel(jobId)** - cancels running or queued job
       - If queued: remove from queue, set status to 'cancelled'
       - If processing: set flag to stop after current EPUB
       - If completed/failed/cancelled: return current status

    7. **setProgressCallback(jobId, callback)** - register SSE callback
       - Store callback to be called during processing

    Import ProcessRequest, JobStatus, JobState, EpubProgress, ResultsOutput from @epub-counter/shared.

    For EPUB processing, reuse existing logic from src/cli/index.ts processEpubs():
    - Use discoverEpubFiles() from src/file-discovery/scanner.ts
    - Use processEpubsWithErrors() from src/errors/handler.ts
    - Wrap in workspace-relative imports
  </action>
  <verify>grep -q "class JobQueue\|export.*JobQueue" server/src/lib/job-queue.ts</verify>
  <done>JobQueue class is exported with enqueue, getStatus, and cancel methods</done>
</task>

<task type="auto">
  <name>Task 3: Create singleton job queue instance</name>
  <files>server/src/lib/job-queue.ts</files>
  <action>
    Add singleton export to server/src/lib/job-queue.ts:

    ```typescript
    // Singleton instance for the server
    export const jobQueue = new JobQueue()
    ```

    This allows all routes to share the same queue instance.
  </action>
  <verify>grep -q "export const jobQueue" server/src/lib/job-queue.ts</verify>
  <done>Singleton jobQueue instance is exported for use across routes</done>
</task>

</tasks>

<verification>
1. Build server: cd server && npm run build
2. Check job-queue.ts exports: grep -E "class JobQueue|export.*jobQueue" server/src/lib/job-queue.ts
3. Verify types are exported: grep -E "JobStatus|JobState|ProcessRequest" packages/shared/src/types.ts
4. Verify shared package builds: npm run build --workspace=@epub-counter/shared
</verification>

<success_criteria>
- JobQueue class exists with enqueue, getStatus, cancel methods
- Jobs are stored in Map with unique IDs
- Job status enum includes: queued, processing, completed, failed, cancelled
- Progress callback mechanism exists for SSE integration
- Singleton jobQueue instance is exported
- Shared types include JobStatus, JobState, EpubProgress, ProcessRequest
</success_criteria>

<output>
After completion, create `.planning/phases/05-backend-api-file-processing/05-02-SUMMARY.md`
</output>
