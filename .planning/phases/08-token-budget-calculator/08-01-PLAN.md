---
phase: 08-token-budget-calculator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/package.json
  - web/src/components/ui/tabs.tsx
  - web/src/components/budget/BudgetCalculator.tsx
  - web/src/hooks/use-debounce.ts
  - web/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can input token budget via number input field"
    - "User can click preset buttons (32K, 128K, 200K) to set budget"
    - "User can select tokenizer from dropdown (GPT-4, Claude, HF models)"
    - "User can select optimization strategy via tabs (Max Books, Max Words, Balanced)"
    - "Budget calculator state is saved to localStorage and restored on page load"
    - "Calculate button is disabled when budget is zero or empty"
    - "Budget calculator shows error when budget is insufficient for at least one EPUB"
  artifacts:
    - path: "web/src/components/ui/tabs.tsx"
      provides: "Radix UI Tabs component for strategy selection"
      min_lines: 50
      exports: ["Tabs", "TabsList", "TabsTrigger", "TabsContent"]
    - path: "web/src/components/budget/BudgetCalculator.tsx"
      provides: "Budget input form with presets, tokenizer dropdown, strategy tabs"
      min_lines: 120
      exports: ["BudgetCalculator"]
    - path: "web/src/hooks/use-debounce.ts"
      provides: "Debounce hook for auto-recalculation on input changes"
      min_lines: 20
      exports: ["useDebounce"]
  key_links:
    - from: "web/src/components/budget/BudgetCalculator.tsx"
      to: "web/src/hooks/use-debounce.ts"
      via: "import useDebounce hook for budget input debouncing"
      pattern: "import.*useDebounce|useDebounce\\("
    - from: "web/src/components/budget/BudgetCalculator.tsx"
      to: "web/src/hooks/use-local-storage.ts"
      via: "useLocalStorage hook for state persistence"
      pattern: "useLocalStorage"
    - from: "web/src/App.tsx"
      to: "web/src/components/budget/BudgetCalculator.tsx"
      via: "Import and render when results exist"
      pattern: "import.*BudgetCalculator|<BudgetCalculator"
---

<objective>
Implement budget calculator form UI with number input, preset buttons, tokenizer dropdown, and strategy selection tabs with localStorage persistence.

**Purpose:** Users need to input their token budget and select optimization strategy before the knapsack algorithm can calculate optimal EPUB selection. The form provides intuitive controls for budget entry (manual input or quick presets) and strategy selection (Max Books vs Max Words vs Balanced) that define how the calculator will optimize book selection.

**Output:** Working budget calculator form component with:
- Number input field for manual budget entry (accepts positive integers only)
- Three preset buttons (32K, 128K, 200K) that set budget and highlight active preset
- Tokenizer dropdown populated with available tokenizers from results
- Radix UI Tabs for strategy selection (Max Books, Max Words, Balanced)
- Debounced input (500ms) to prevent excessive recalculations
- localStorage persistence for budget, tokenizer, and strategy selections
- Validation showing error when budget is insufficient for any EPUB
</objective>

<execution_context>
@/Users/vinicusmoreira/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vinicusmoreira/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-token-budget-calculator/08-CONTEXT.md
@.planning/phases/08-token-budget-calculator/08-RESEARCH.md
@.planning/phases/06-file-upload-tokenizer-selection/06-01-SUMMARY.md
@packages/shared/src/types.ts
@web/src/App.tsx
@web/src/hooks/use-local-storage.ts
</context>

<tasks>

<task type="auto">
  <name>Install Radix UI Tabs and create useDebounce hook</name>
  <files>web/package.json, web/src/hooks/use-debounce.ts</files>
  <action>
    1. Install Radix UI Tabs:
       ```bash
       cd web && npx shadcn@latest add tabs
       ```
       This adds @radix-ui/react-tabs and creates tabs.tsx in components/ui/.

    2. Create web/src/hooks/use-debounce.ts:
       - Accept value: T and delay: number parameters (default 500ms)
       - Use useState for debouncedValue
       - Use useEffect to update debouncedValue after delay
       - Return debouncedValue
       - Include cleanup to reset timer on value change

    Reference the research pattern for useDebounce implementation. Use setTimeout/clearTimeout pattern.
  </action>
  <verify>
    ```bash
      grep -q "@radix-ui/react-tabs" web/package.json && test -f web/src/hooks/use-debounce.ts
    ```
  </verify>
  <done>
    Radix UI Tabs is installed and tabs.tsx exists in components/ui/. useDebounce hook is exported from hooks/use-debounce.ts
  </done>
</task>

<task type="auto">
  <name>Create BudgetCalculator component with form UI</name>
  <files>web/src/components/budget/BudgetCalculator.tsx</files>
  <action>
    Create budget directory and BudgetCalculator component:

    1. Create web/src/components/budget/BudgetCalculator.tsx with interface:
       Props:
       - results: EpubResult[] (passed from App state)
       - onCalculate: (budget, tokenizer, strategy) => void callback

    2. State management with useLocalStorage:
       - budget: number (default 128000)
       - selectedPreset: number | null (tracks if preset active)
       - tokenizer: TokenizerType (default first from results)
       - strategy: 'max-books' | 'max-words' | 'balanced' (default 'max-books')

    3. Budget input section:
       - Label "Token Budget"
       - Number input with value={state.budget}, onChange to setBudget
       - Three buttons: "32K", "128K", "200K" with variant={selectedPreset === value ? 'default' : 'outline'}
       - Input disabled: false (always enabled for editing)

    4. Tokenizer dropdown:
       - Label "Tokenizer"
       - Native select element with options from unique tokenizer names in results
       - Use TokenizerInfo from Phase 6 for display names if available

    5. Strategy tabs (Radix UI):
       - Tabs component with value={strategy}, onValueChange
       - TabsList with three TabsTrigger: "Max Books", "Max Words", "Balanced"
       - TabsContent showing description for each strategy:
         * Max Books: "Select shortest books first to maximize count"
         * Max Words: "Select longest books that fit to maximize total words"
         * Balanced: "Balance book count and word density"

    6. Validation:
       - Calculate minimum token count across all EPUBs
       - Show error message if budget < minTokens
       - Pass isValid to parent for calculate button state

    Import types from @epub-counter/shared. Use useLocalStorage for persistence. Use useDebounce for budget input.
  </action>
  <verify>
    ```bash
      test -f web/src/components/budget/BudgetCalculator.tsx && grep -q "export.*BudgetCalculator" web/src/components/budget/BudgetCalculator.tsx
    ```
  </verify>
  <done>
    BudgetCalculator.tsx exports component with budget input, presets, tokenizer dropdown, and strategy tabs
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete budget calculator form with:
    - Radix UI Tabs component installed
    - useDebounce hook for input debouncing
    - BudgetCalculator component with input, presets, tokenizer dropdown, strategy tabs
  </what-built>
  <how-to-verify>
    1. Start dev server: npm run dev (in root) or cd web && npm run dev
    2. Upload a results.json file or process EPUBs to get results
    3. Verify BudgetCalculator section appears after completion
    4. Test budget input: type 50000, verify value updates
    5. Click preset buttons (32K, 128K, 200K): verify budget updates and button highlights
    6. Change tokenizer dropdown: verify selection persists after page refresh (localStorage)
    7. Click strategy tabs: verify description text changes for each strategy
    8. Refresh page: verify all selections are restored (budget, tokenizer, strategy)
    9. Enter budget lower than minimum EPUB tokens: verify error message appears
    10. Check browser console for errors
  </how-to-verify>
  <resume-signal>Type "approved" if form works correctly, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Integrate BudgetCalculator into App.tsx</name>
  <files>web/src/App.tsx</files>
  <action>
    Update web/src/App.tsx to render BudgetCalculator after visualizations:

    1. Import BudgetCalculator from components/budget/BudgetCalculator

    2. Add state for budget calculator selections:
       - const [budgetState, setBudgetState] = useState(...) for budget, tokenizer, strategy

    3. After all visualization components (after ComparisonBarChart), add new section:
       - Heading "Token Budget Calculator"
       - Render BudgetCalculator with results and onCalculate callback
       - Pass onCalculate that sets budgetState for use in next plan (08-03)

    4. Only render BudgetCalculator when processingResults exists and has valid results

    Reference the visualization section layout for consistency. Use Card wrapper.
  </action>
  <verify>
    ```bash
      grep -q "BudgetCalculator" web/src/App.tsx
    ```
  </verify>
  <done>
    App.tsx renders BudgetCalculator section after visualizations when results exist
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. Radix UI Tabs is installed and tabs.tsx exists in components/ui/
2. useDebounce hook exists and is exported from hooks/use-debounce.ts
3. BudgetCalculator component has budget input, preset buttons, tokenizer dropdown, strategy tabs
4. Budget input accepts positive integers and rejects negative/zero values
5. Preset buttons (32K, 128K, 200K) set budget and highlight active selection
6. Tokenizer dropdown shows all tokenizers from results
7. Strategy tabs switch between Max Books, Max Words, Balanced with descriptions
8. All state persists to localStorage and restores on page load
9. Error message displays when budget < minimum EPUB token count
10. App.tsx renders BudgetCalculator after visualizations
</verification>

<success_criteria>
1. User sees budget calculator form with number input, preset buttons, tokenizer dropdown, and strategy tabs
2. Typing in budget input updates value with 500ms debounce
3. Clicking preset buttons sets budget and highlights active preset
4. Tokenizer dropdown shows available tokenizers from results
5. Strategy tabs display different descriptions for Max Books, Max Words, Balanced
6. All form selections persist after page refresh (localStorage)
7. Error message appears when budget is insufficient for any EPUB
8. No console errors when interacting with form
</success_criteria>

<output>
After completion, create `.planning/phases/08-token-budget-calculator/08-01-SUMMARY.md` with summary of implementation
</output>
