---
phase: 08-token-budget-calculator
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - web/src/components/budget/BudgetSummary.tsx
  - web/src/components/budget/BudgetProgressBar.tsx
  - web/src/components/budget/SelectedBooksTable.tsx
  - web/src/components/budget/ExportButtons.tsx
  - web/src/lib/clipboard-utils.ts
  - web/src/lib/json-download.ts
  - web/src/components/budget/BudgetCalculator.tsx
  - web/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees summary bar showing selected book count, total tokens, remaining tokens, percentage used"
    - "User sees progress bar visualizing budget utilization (tokens used / budget)"
    - "User sees table of selected books with columns: Title, Author, Words, Tokens"
    - "User can sort table by any column (title, author, words, tokens)"
    - "User can click 'Copy to Clipboard' button to copy selected book list"
    - "User can click 'Download JSON' button to download selected book list as JSON file"
    - "Table reuses TanStack Table patterns from Phase 07 for consistency"
  artifacts:
    - path: "web/src/components/budget/BudgetSummary.tsx"
      provides: "Summary bar showing count, total tokens, remaining, percentage"
      min_lines: 30
      exports: ["BudgetSummary"]
    - path: "web/src/components/budget/BudgetProgressBar.tsx"
      provides: "Progress bar component showing budget utilization"
      min_lines: 40
      exports: ["BudgetProgressBar"]
    - path: "web/src/components/budget/SelectedBooksTable.tsx"
      provides: "TanStack Table for selected books with sorting and export"
      min_lines: 120
      exports: ["SelectedBooksTable"]
    - path: "web/src/components/budget/ExportButtons.tsx"
      provides: "Copy and download buttons with clipboard/JSON functionality"
      min_lines: 60
      exports: ["ExportButtons"]
    - path: "web/src/lib/clipboard-utils.ts"
      provides: "Copy to clipboard utilities with fallback"
      min_lines: 50
      exports: ["copyToClipboard", "formatBooksForClipboard", "useCopyToClipboard"]
    - path: "web/src/lib/json-download.ts"
      provides: "JSON file download utilities using Blob API"
      min_lines: 50
      exports: ["downloadJson", "formatExportData", "useJsonDownload"]
  key_links:
    - from: "web/src/components/budget/SelectedBooksTable.tsx"
      to: "@tanstack/react-table"
      via: "Import useReactTable for table logic"
      pattern: "from '@tanstack/react-table'"
    - from: "web/src/components/budget/ExportButtons.tsx"
      to: "web/src/lib/clipboard-utils.ts"
      via: "Import useCopyToClipboard hook"
      pattern: "import.*useCopyToClipboard"
    - from: "web/src/components/budget/ExportButtons.tsx"
      to: "web/src/lib/json-download.ts"
      via: "Import useJsonDownload hook"
      pattern: "import.*useJsonDownload"
    - from: "web/src/lib/clipboard-utils.ts"
      to: "navigator.clipboard"
      via: "Clipboard API with document.execCommand fallback"
      pattern: "navigator.clipboard|execCommand"
    - from: "web/src/lib/json-download.ts"
      to: "URL.createObjectURL"
      via: "Blob API for client-side file generation"
      pattern: "createObjectURL|new Blob"
---

<objective>
Implement budget display UI with summary bar, progress bar, selected books table (TanStack Table), and export buttons (copy/clipboard, JSON download).

**Purpose:** After the knapsack algorithm selects EPUBs within budget, users need to see the selection details. The summary bar provides high-level metrics (count, tokens used, remaining). The progress bar visualizes budget utilization. The table shows individual book details with sorting. Export buttons enable users to copy or download the selection for reference.

**Output:** Working budget display components with:
- Summary bar: "15 selected · 45,231 / 128,000 tokens (64% used)"
- Progress bar with percentage and remaining tokens
- TanStack Table with Title, Author, Words, Tokens columns (sortable)
- Copy to clipboard button using Clipboard API with fallback
- Download JSON button using Blob API for client-side file generation
</objective>

<execution_context>
@/Users/vinicusmoreira/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vinicusmoreira/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-token-budget-calculator/08-CONTEXT.md
@.planning/phases/08-token-budget-calculator/08-RESEARCH.md
@.planning/phases/07-data-visualization/07-03-SUMMARY.md
@.planning/phases/08-token-budget-calculator/08-01-SUMMARY.md
@.planning/phases/08-token-budget-calculator/08-02-SUMMARY.md
@packages/shared/src/types.ts
@web/src/components/ui/progress.tsx
@web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Create clipboard and JSON download utilities</name>
  <files>web/src/lib/clipboard-utils.ts, web/src/lib/json-download.ts</files>
  <action>
    Create utility files for export functionality:

    1. Create web/src/lib/clipboard-utils.ts:
       - Define CopyData interface: { title, author, wordCount, tokenCount }
       - Export formatBooksForClipboard(books): string with formatted text
       - Export copyToClipboard(text): Promise<boolean> with Clipboard API + fallback
         * Try navigator.clipboard.writeText() if secure context
         * Fallback to document.execCommand('copy') with textarea
       - Export useCopyToClipboard(): React hook wrapping copyToClipboard
         * Call formatBooksForClipboard then copyToClipboard
         * Show toast via sonner on success/error
         * Return { copy } function

    2. Create web/src/lib/json-download.ts:
       - Define ExportData interface with exportedAt, budget, tokenizer, strategy, selectedBooks, summary
       - Export formatExportData(books, budget, tokenizer, strategy): ExportData
       - Export downloadJson(data, filename): void
         * Create Blob with JSON.stringify(data, null, 2)
         * Create object URL with URL.createObjectURL(blob)
         * Create anchor element, set href and download attributes
         * Trigger click, cleanup element and revokeObjectURL
       - Export useJsonDownload(): React hook
         * Call formatExportData then downloadJson
         * Return { download } function

    Reference the research pattern for complete implementations. Use toast from 'sonner' for notifications. Ensure proper cleanup in downloadJson.

    CRITICAL: Always revokeObjectURL after download to prevent memory leaks.
  </action>
  <verify>
    ```bash
      test -f web/src/lib/clipboard-utils.ts && test -f web/src/lib/json-download.ts && grep -q "export.*copyToClipboard" web/src/lib/clipboard-utils.ts && grep -q "export.*downloadJson" web/src/lib/json-download.ts
    ```
  </verify>
  <done>
    clipboard-utils.ts exports copyToClipboard and useCopyToClipboard. json-download.ts exports downloadJson and useJsonDownload
  </done>
</task>

<task type="auto">
  <name>Create summary and progress bar components</name>
  <files>web/src/components/budget/BudgetSummary.tsx, web/src/components/budget/BudgetProgressBar.tsx</files>
  <action>
    Create display components for budget metrics:

    1. Create web/src/components/budget/BudgetSummary.tsx:
       Props: { count, totalTokens, budget }
       - Render summary text: "{count} selected · {totalTokens} / {budget} tokens ({percent}% used)"
       - Use bold for count, muted for secondary text
       - Calculate percent: Math.round((totalTokens / budget) * 100)
       - Format numbers with toLocaleString()

    2. Create web/src/components/budget/BudgetProgressBar.tsx:
       Props: { used, remaining, total }
       - Wrap in shadcn/ui Card
       - Show heading "Budget Utilization" with used/total counts
       - Render shadcn/ui Progress component with value=(used/total)*100
       - Show percentage and remaining tokens below progress bar
       - Use consistent styling with other progress displays

    Import Progress from @/components/ui/progress. Import Card from @/components/ui/card.

    Reference the research pattern for progress bar implementation.
  </action>
  <verify>
    ```bash
      test -f web/src/components/budget/BudgetSummary.tsx && test -f web/src/components/budget/BudgetProgressBar.tsx
    ```
  </verify>
  <done>
    BudgetSummary and BudgetProgressBar components exist and export default
  </done>
</task>

<task type="auto">
  <name>Create SelectedBooksTable with TanStack Table</name>
  <files>web/src/components/budget/SelectedBooksTable.tsx</files>
  <action>
    Create web/src/components/budget/SelectedBooksTable.tsx:

    Props:
    - books: EpubResult[]
    - tokenizer: string
    - budget: number
    - strategy: string

    Implementation:
    1. Use useState for SortingState (default: [{ id: 'tokens', desc: true }])
    2. Define columns with useMemo:
       - Select column: disabled checkbox (shows selected state)
       - Title: accessorFn -> metadata.title
       - Author: accessorFn -> metadata.author
       - Words: accessorFn -> wordCount.toLocaleString()
       - Tokens: accessorFn -> tokenCounts.find(t => t.name === tokenizer)?.count.toLocaleString()
    3. Create table with useReactTable:
       - getCoreRowModel, getSortedRowModel
       - state: { sorting }, onSortingChange
    4. Render shadcn/ui Card with table
    5. Table header with sortable columns (click to sort)
    6. Table body with rows showing book data
    7. Hover state on rows (hover:bg-accent/30)

    Import types from @epub-counter/shared. Use flexRender from TanStack Table. Reference Phase 07 ResultsTable for patterns.

    CRITICAL: Access token count via tokenCounts.find(t => t.name === tokenizer)?.count
  </action>
  <verify>
    ```bash
      test -f web/src/components/budget/SelectedBooksTable.tsx && grep -q "useReactTable" web/src/components/budget/SelectedBooksTable.tsx
    ```
  </verify>
  <done>
    SelectedBooksTable.tsx exports component using TanStack Table with sortable columns
  </done>
</task>

<task type="auto">
  <name>Create ExportButtons component</name>
  <files>web/src/components/budget/ExportButtons.tsx</files>
  <action>
    Create web/src/components/budget/ExportButtons.tsx:

    Props:
    - books: EpubResult[]
    - tokenizer: string
    - budget: number
    - strategy: string

    Implementation:
    1. Use useCopyToClipboard hook
    2. Use useJsonDownload hook
    3. Transform books to CopyData[] for clipboard:
       - Map to { title, author, wordCount, tokenCount }
       - Get tokenCount via tokenCounts.find()
    4. Render two buttons with flex row:
       - Copy button: Copy icon (lucide-react), "Copy" text, variant="outline"
         * onClick: call copy() with transformed data
       - Download JSON button: Download icon, "Download JSON" text, variant="outline"
         * onClick: call download() with books, budget, tokenizer, strategy
    5. Show toasts via useCopyToClipboard on success/error

    Import Copy, Download icons from lucide-react. Import Button from @/components/ui/button. Import hooks from lib utilities.
  </action>
  <verify>
    ```bash
      test -f web/src/components/budget/ExportButtons.tsx && grep -q "useCopyToClipboard\|useJsonDownload" web/src/components/budget/ExportButtons.tsx
    ```
  </verify>
  <done>
    ExportButtons.tsx exports component with Copy and Download JSON buttons
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete budget display UI with:
    - Clipboard and JSON download utility functions
    - BudgetSummary component with metrics
    - BudgetProgressBar component with progress visualization
    - SelectedBooksTable with TanStack Table and sorting
    - ExportButtons with copy and download functionality
  </what-built>
  <how-to-verify>
    1. Start dev server: npm run dev (in root) or cd web && npm run dev
    2. Upload a results.json file with multiple EPUBs
    3. Set budget (e.g., 128000) and select tokenizer
    4. Select a strategy and wait for calculation (500ms debounce)
    5. Verify summary bar shows correct count, tokens used, remaining, percentage
    6. Verify progress bar shows correct percentage with colored fill
    7. Verify table shows selected books with correct Title, Author, Words, Tokens
    8. Click column headers to sort: verify sorting changes correctly
    9. Click Copy button: verify toast success message, paste to test clipboard content
    10. Click Download JSON button: verify file downloads with correct name and content
    11. Check browser console for errors
  </how-to-verify>
  <resume-signal>Type "approved" if display UI works correctly, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Integrate budget display into BudgetCalculator and App</name>
  <files>web/src/components/budget/BudgetCalculator.tsx, web/src/App.tsx</files>
  <action>
    Update BudgetCalculator and App to use useBudgetCalculator hook and display results:

    1. Update web/src/components/budget/BudgetCalculator.tsx:
       - Import useBudgetCalculator from hooks/use-budget-calculator
       - Import BudgetSummary, BudgetProgressBar, SelectedBooksTable, ExportButtons
       - Replace useState with useBudgetCalculator(results) hook
       - Destructure: state, result, isValid, setBudget, setPreset, setTokenizer, setStrategy
       - Only render budget input section (remove onCalculate callback)
       - After form, conditionally render result section if result.selectedBooks.length > 0:
         * Render BudgetSummary with count, totalTokens, budget
         * Render BudgetProgressBar with used, remaining, total
         * Render SelectedBooksTable with books, tokenizer
         * Render ExportButtons with books, tokenizer, budget, strategy
       - Show error message if !isValid

    2. Update web/src/App.tsx (if needed):
       - Ensure BudgetCalculator receives results prop
       - Remove any intermediate state management (now handled by hook)

    Use the existing BudgetCalculator file structure. Add result display section after the form.
  </action>
  <verify>
    ```bash
      grep -q "useBudgetCalculator" web/src/components/budget/BudgetCalculator.tsx && grep -q "BudgetSummary\|SelectedBooksTable" web/src/components/budget/BudgetCalculator.tsx
    ```
  </verify>
  <done>
    BudgetCalculator.tsx uses useBudgetCalculator hook and renders summary, progress bar, table, export buttons when results exist
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. clipboard-utils.ts exports copyToClipboard with Clipboard API and execCommand fallback
2. json-download.ts exports downloadJson using Blob API with proper cleanup
3. BudgetSummary displays count, tokens used, budget, percentage
4. BudgetProgressBar shows progress bar with correct percentage and remaining tokens
5. SelectedBooksTable uses TanStack Table with sortable columns (title, author, words, tokens)
6. ExportButtons has Copy and Download JSON buttons with proper icons
7. Copy button copies formatted book list to clipboard and shows success toast
8. Download JSON button triggers file download with ExportData structure
9. BudgetCalculator uses useBudgetCalculator hook and displays all result components
10. All components render correctly when knapsack calculation returns selected books
</verification>

<success_criteria>
1. User sees summary bar with "X selected · Y / Z tokens (P% used)" format
2. Progress bar shows visual percentage with colored fill and remaining tokens
3. Table displays selected books with sortable columns
4. Clicking column headers sorts by that column (ascending/descending)
5. Copy button copies book list to clipboard and shows success toast
6. Download JSON button downloads file with metadata and selected books
7. All display components only render when selected books exist (result.selectedBooks.length > 0)
8. No console errors when interacting with display UI
</success_criteria>

<output>
After completion, create `.planning/phases/08-token-budget-calculator/08-03-SUMMARY.md` with summary of implementation
</output>
