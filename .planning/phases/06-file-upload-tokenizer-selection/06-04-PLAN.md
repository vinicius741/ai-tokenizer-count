---
phase: 06-file-upload-tokenizer-selection
plan: 04
type: execute
wave: 3
depends_on: [06-03]
files_modified:
  - web/src/hooks/use-sse-connection.ts
  - web/src/components/progress/ProcessingProgress.tsx
  - web/src/components/progress/CompletionSummary.tsx
  - web/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees progress bar showing percentage completion"
    - "Progress bar uses animated striped animation style"
    - "User sees current EPUB filename below progress bar"
    - "User sees ETA calculation based on remaining EPUBs and average time"
    - "Progress updates in real-time via SSE connection"
    - "SSE connection uses @microsoft/fetch-event-source library"
    - "On completion, progress section transforms into summary card"
    - "Summary card shows total EPUBs processed and completion status"
  artifacts:
    - path: "web/src/hooks/use-sse-connection.ts"
      provides: "Custom hook wrapping fetch-event-source for SSE"
      min_lines: 60
    - path: "web/src/components/progress/ProcessingProgress.tsx"
      provides: "Progress display with bar, current file, and ETA"
      min_lines: 80
    - path: "web/src/components/progress/CompletionSummary.tsx"
      provides: "Results summary card shown after completion"
      min_lines: 40
  key_links:
    - from: "web/src/hooks/use-sse-connection.ts"
      to: "GET /api/sse/:jobId"
      via: "fetchEventSource from @microsoft/fetch-event-source"
      pattern: "fetchEventSource.*api/sse"
    - from: "web/src/components/progress/ProcessingProgress.tsx"
      to: "web/src/hooks/use-sse-connection.ts"
      via: "import useSseConnection hook"
      pattern: "useSseConnection"
    - from: "web/src/App.tsx"
      to: "web/src/components/progress/ProcessingProgress.tsx"
      via: "jobId prop"
      pattern: "ProcessingProgress.*jobId"
---

<objective>
Create real-time progress display with SSE integration showing animated striped progress bar, current file, ETA, and completion summary card.

Purpose: Provide users with live feedback during EPUB processing and clear summary when complete.

Output: Working progress display with SSE streaming, animated progress bar, ETA calculation, and completion transformation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-upload-tokenizer-selection/06-CONTEXT.md
@.planning/phases/06-file-upload-tokenizer-selection/06-RESEARCH.md
@.planning/phases/05-backend-api-file-processing/05-04-SUMMARY.md

# SSE Endpoint (from Phase 5)
- GET /api/sse/:jobId â€” Server-Sent Events streaming progress updates
- Events: 'progress' { current, total, filename, timestamp }, 'completed' { results }, 'error' { message }

# @microsoft/fetch-event-source API
- fetchEventSource(url, { signal, onopen, onmessage, onerror })
- Supports abort signals for cancellation
- Better than native EventSource (POST support, custom headers, retry control)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Progress component and add striped animation CSS</name>
  <files>web/src/components/ui/progress.tsx, web/src/index.css</files>
  <action>
1. Install shadcn/ui Progress component:
```bash
cd web
npx shadcn@latest add progress
```

2. Add striped progress animation to web/src/index.css:
```css
/* Add to web/src/index.css */

@keyframes progress-stripes {
  from {
    background-position: 1rem 0;
  }
  to {
    background-position: 0 0;
  }
}

.progress-striped {
  background-image: linear-gradient(
    45deg,
    rgba(255, 255, 255, 0.15) 25%,
    transparent 25%,
    transparent 50%,
    rgba(255, 255, 255, 0.15) 50%,
    rgba(255, 255, 255, 0.15) 75%,
    transparent 75%,
    transparent
  );
  background-size: 1rem 1rem;
  animation: progress-stripes 1s linear infinite;
}
```

This follows the pattern from 06-RESEARCH.md "Progress Bar with Animated Stripes".
  </action>
  <verify>web/src/components/ui/progress.tsx exists and web/src/index.css contains @keyframes progress-stripes and .progress-striped class</verify>
  <done>Progress component installed and striped animation CSS added</done>
</task>

<task type="auto">
  <name>Task 2: Create useSseConnection hook wrapping fetch-event-source</name>
  <files>web/src/hooks/use-sse-connection.ts</files>
  <action>
Create custom hook wrapping @microsoft/fetch-event-source:

```typescript
// web/src/hooks/use-sse-connection.ts
import { useCallback, useEffect, useRef } from 'react'
import { fetchEventSource } from '@microsoft/fetch-event-source'

export interface ProgressData {
  current: number
  total: number
  filename: string
  timestamp: string
}

export interface SseCallbacks {
  onProgress: (data: ProgressData) => void
  onComplete: (results: unknown) => void
  onError: (error: string) => void
}

export function useSseConnection() {
  const abortControllerRef = useRef<AbortController | null>(null)

  const connect = useCallback(async (
    jobId: string,
    callbacks: SseCallbacks
  ) => {
    // Abort any existing connection
    if (abortControllerRef.current) {
      abortControllerRef.current.abort()
    }

    abortControllerRef.current = new AbortController()

    const { onProgress, onComplete, onError } = callbacks

    try {
      await fetchEventSource(`http://localhost:8787/api/sse/${jobId}`, {
        method: 'GET',
        signal: abortControllerRef.current.signal,

        onopen(response) {
          if (response.ok && response.headers.get('content-type') === 'text/event-stream') {
            return
          }
          throw new Error(`Unexpected response: ${response.status}`)
        },

        onmessage(msg) {
          if (msg.event === 'progress') {
            const data = JSON.parse(msg.data) as ProgressData
            onProgress(data)
          } else if (msg.event === 'completed') {
            const results = JSON.parse(msg.data)
            onComplete(results)
          } else if (msg.event === 'error') {
            const error = JSON.parse(msg.data) as { message: string }
            onError(error.message)
          }
        },

        onerror(err) {
          onError(err.message)
          throw err // Stop retry on fatal error
        },
      })
    } catch (error) {
      if (error instanceof Error && error.name !== 'AbortError') {
        onError(error.message)
      }
    }
  }, [])

  const disconnect = useCallback(() => {
    abortControllerRef.current?.abort()
    abortControllerRef.current = null
  }, [])

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      disconnect()
    }
  }, [disconnect])

  return { connect, disconnect }
}
```

Hook should:
- Use @microsoft/fetch-event-source for SSE
- Support abort signals for cancellation
- Handle progress, completed, and error events
- Cleanup connections on unmount
- Parse SSE event data correctly
  </action>
  <verify>web/src/hooks/use-sse-connection.ts exists and exports useSseConnection hook with ProgressData and SseCallbacks types</verify>
  <done>useSseConnection hook created with proper SSE handling and cleanup</done>
</task>

<task type="auto">
  <name>Task 3: Create ProcessingProgress component with striped bar and ETA</name>
  <files>web/src/components/progress/ProcessingProgress.tsx</files>
  <action>
Create ProcessingProgress component:

```typescript
// web/src/components/progress/ProcessingProgress.tsx
import { useEffect, useState, useMemo } from 'react'
import { Progress } from '@/components/ui/progress'
import { Clock, FileText } from 'lucide-react'
import { cn } from '@/lib/utils'
import { useSseConnection, type ProgressData } from '@/hooks/use-sse-connection'
import type { ResultsOutput } from '@epub-counter/shared'

interface ProcessingProgressProps {
  jobId: string
  onComplete: (results: ResultsOutput) => void
}

export function ProcessingProgress({ jobId, onComplete }: ProcessingProgressProps) {
  const [progress, setProgress] = useState<ProgressData>({
    current: 0,
    total: 0,
    filename: '',
    timestamp: new Date().toISOString(),
  })
  const [startTime] = useState(() => Date.now())

  const percentage = progress.total > 0
    ? Math.round((progress.current / progress.total) * 100)
    : 0

  // Calculate ETA based on average time per EPUB
  const eta = useMemo(() => {
    if (progress.current === 0 || progress.total === 0) return null

    const elapsed = Date.now() - startTime
    const avgTimePerEpub = elapsed / progress.current
    const remaining = progress.total - progress.current
    const etaMs = avgTimePerEpub * remaining

    const minutes = Math.floor(etaMs / 60000)
    const seconds = Math.floor((etaMs % 60000) / 1000)

    if (minutes > 0) {
      return `${minutes}m ${seconds}s remaining`
    }
    return `${seconds}s remaining`
  }, [progress.current, progress.total, startTime])

  const { connect } = useSseConnection()

  useEffect(() => {
    connect(jobId, {
      onProgress: (data) => {
        setProgress(data)
      },
      onComplete: (results) => {
        onComplete(results as ResultsOutput)
      },
      onError: (error) => {
        console.error('SSE error:', error)
      },
    })
  }, [jobId, connect, onComplete])

  return (
    <div className="space-y-3 p-4 border rounded-lg bg-muted/30">
      {/* Progress bar with stripes */}
      <div className="space-y-2">
        <div className="flex items-center justify-between text-sm">
          <span className="font-medium">Processing EPUBs</span>
          <span className="text-muted-foreground">
            {progress.current} / {progress.total} ({percentage}%)
          </span>
        </div>

        <div className="relative">
          <Progress value={percentage} className="h-3" />
          {/* Striped overlay */}
          {percentage > 0 && (
            <div
              className={cn(
                "absolute inset-0 progress-striped rounded-full",
                "opacity-50"
              )}
              style={{ width: `${percentage}%` }}
            />
          )}
        </div>
      </div>

      {/* Current file */}
      {progress.filename && (
        <div className="flex items-center gap-2 text-sm text-muted-foreground">
          <FileText className="h-4 w-4 shrink-0" />
          <span className="truncate">{progress.filename}</span>
        </div>
      )}

      {/* ETA */}
      {eta && progress.current > 0 && (
        <div className="flex items-center gap-2 text-sm text-muted-foreground">
          <Clock className="h-4 w-4 shrink-0" />
          <span>{eta}</span>
        </div>
      )}
    </div>
  )
}
```

Component should:
- Connect to SSE endpoint using useSseConnection hook
- Show percentage completion
- Display animated striped progress bar
- Show current EPUB filename
- Calculate and display ETA
- Handle completion callback
  </action>
  <verify>web/src/components/progress/ProcessingProgress.tsx exists and exports ProcessingProgress component</verify>
  <done>ProcessingProgress created with SSE integration, striped progress bar, ETA calculation, and current file display</done>
</task>

<task type="auto">
  <name>Task 4: Create CompletionSummary card for results</name>
  <files>web/src/components/progress/CompletionSummary.tsx</files>
  <action>
Create CompletionSummary component:

```typescript
// web/src/components/progress/CompletionSummary.tsx
import { CheckCircle2 } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import type { ResultsOutput } from '@epub-counter/shared'

interface CompletionSummaryProps {
  results: ResultsOutput
}

export function CompletionSummary({ results }: CompletionSummaryProps) {
  const successCount = results.results.filter(r =>
    r.tokenCounts && Object.keys(r.tokenCounts).length > 0
  ).length

  const failedCount = results.summary.failed

  return (
    <Card className="border-green-200 bg-green-50/50 dark:bg-green-950/20">
      <CardHeader className="pb-3">
        <CardTitle className="flex items-center gap-2 text-green-700 dark:text-green-400">
          <CheckCircle2 className="h-5 w-5" />
          Processing Complete
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-2 text-sm">
        <div className="flex justify-between">
          <span className="text-muted-foreground">Total EPUBs:</span>
          <span className="font-medium">{results.summary.total}</span>
        </div>
        <div className="flex justify-between">
          <span className="text-muted-foreground">Successful:</span>
          <span className="font-medium text-green-700 dark:text-green-400">
            {successCount}
          </span>
        </div>
        {failedCount > 0 && (
          <div className="flex justify-between">
            <span className="text-muted-foreground">Failed:</span>
            <span className="font-medium text-destructive">
              {failedCount}
            </span>
          </div>
        )}
        <div className="pt-2 border-t">
          <p className="text-xs text-muted-foreground">
            Tokenizers used: {results.options.tokenizerList.join(', ')}
          </p>
        </div>
      </CardContent>
    </Card>
  )
}
```

Component should:
- Show success icon and title
- Display total, successful, and failed counts
- Show which tokenizers were used
- Use green color scheme for success state
  </action>
  <verify>web/src/components/progress/CompletionSummary.tsx exists and exports CompletionSummary component</verify>
  <done>CompletionSummary created showing processing results with success styling</done>
</task>

<task type="auto">
  <name>Task 5: Update App.tsx to integrate progress components</name>
  <files>web/src/App.tsx</files>
  <action>
Update App.tsx to integrate ProcessingProgress and CompletionSummary:

```typescript
// web/src/App.tsx
import { useState } from 'react'
import { TokenizerSelector } from './components/tokenizer/TokenizerSelector'
import { FileDropzone } from './components/file-upload/FileDropzone'
import { FolderInput } from './components/processing/FolderInput'
import { ProcessButton } from './components/processing/ProcessButton'
import { ProcessingProgress } from './components/progress/ProcessingProgress'
import { CompletionSummary } from './components/progress/CompletionSummary'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import type { ResultsOutput } from '@epub-counter/shared'

function App() {
  const [uploadedResults, setUploadedResults] = useState<ResultsOutput | null>(null)
  const [currentJobId, setCurrentJobId] = useState<string | null>(null)
  const [processingResults, setProcessingResults] = useState<ResultsOutput | null>(null)
  const [folderPath, setFolderPath] = useState('')
  const [selectedTokenizers, setSelectedTokenizers] = useState<string[]>([])

  const handleFileLoaded = (data: ResultsOutput, fileName: string) => {
    setUploadedResults(data)
    console.log('Uploaded results:', fileName, data)
  }

  const handleJobStarted = (jobId: string) => {
    setCurrentJobId(jobId)
    setProcessingResults(null) // Reset previous results
    console.log('Job started:', jobId)
  }

  const handleProcessingComplete = (results: ResultsOutput) => {
    setProcessingResults(results)
    setCurrentJobId(null) // Clear job ID
  }

  return (
    <div className="min-h-screen bg-background p-8">
      <div className="max-w-2xl mx-auto space-y-6">
        <Card>
          <CardHeader>
            <CardTitle>EPUB Tokenizer Counter</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            {/* Tokenizer Selection */}
            <div>
              <h2 className="text-lg font-semibold mb-4">1. Select Tokenizers</h2>
              <TokenizerSelector />
            </div>

            {/* File Upload OR Folder Input */}
            <div>
              <h2 className="text-lg font-semibold mb-4">2. Choose Input Source</h2>
              <div className="space-y-4">
                <div>
                  <label className="text-sm font-medium mb-2 block">
                    Upload existing results.json
                  </label>
                  <FileDropzone onFileLoaded={handleFileLoaded} />
                </div>

                <div className="relative">
                  <div className="absolute inset-0 flex items-center">
                    <span className="w-full border-t" />
                  </div>
                  <div className="relative flex justify-center text-xs uppercase">
                    <span className="bg-background px-2 text-muted-foreground">
                      Or process new EPUBs
                    </span>
                  </div>
                </div>

                <div>
                  <label className="text-sm font-medium mb-2 block">
                    EPUB folder path (server-side)
                  </label>
                  <FolderInput
                    value={folderPath}
                    onChange={setFolderPath}
                  />
                </div>
              </div>
            </div>

            {/* Process Button */}
            <div>
              <ProcessButton
                folderPath={folderPath}
                selectedTokenizers={selectedTokenizers}
                onJobStarted={handleJobStarted}
                disabled={!!currentJobId} // Disable while processing
              />
            </div>

            {/* Progress Display */}
            {currentJobId && !processingResults && (
              <div>
                <h2 className="text-lg font-semibold mb-4">3. Processing Progress</h2>
                <ProcessingProgress
                  jobId={currentJobId}
                  onComplete={handleProcessingComplete}
                />
              </div>
            )}

            {/* Completion Summary */}
            {processingResults && (
              <div>
                <h2 className="text-lg font-semibold mb-4">Complete!</h2>
                <CompletionSummary results={processingResults} />
              </div>
            )}
          </CardContent>
        </Card>

        {/* Debug Info - Remove in production */}
        {currentJobId && (
          <Card>
            <CardContent className="pt-6">
              <p className="text-sm">Current Job ID: {currentJobId}</p>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  )
}

export default App
```

App should:
- Show ProcessingProgress when jobId is set and results not complete
- Transform to CompletionSummary when processing completes
- Disable ProcessButton while processing
- Clear jobId after completion
  </action>
  <verify>web/src/App.tsx updated to show ProcessingProgress during processing and CompletionSummary when complete</verify>
  <done>App.tsx integrates progress components with proper state flow</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete real-time progress display with SSE integration, animated striped progress bar, current file display, ETA calculation, and completion summary card transformation</what-built>
  <how-to-verify>
1. Start both servers: `npm run dev` from project root
2. Open http://localhost:5173 in browser
3. Test the full flow:
   - Select at least one tokenizer
   - Enter a valid EPUB folder path with multiple files
   - Click "Process EPUBs" button
   - Verify ProcessingProgress component appears

4. Verify progress display:
   - Progress bar shows percentage (e.g., "3 / 10 (30%)")
   - Progress bar has animated stripes (check visual animation)
   - Current EPUB filename appears below progress bar
   - ETA shows estimated time remaining (e.g., "2m 15s remaining")
   - Progress updates in real-time as EPUBs are processed

5. Check browser console:
   - Verify SSE connection is established (check Network tab for SSE connection)
   - Verify progress events are received
   - Verify completed event is received

6. Verify completion:
   - When processing finishes, ProcessingProgress disappears
   - CompletionSummary card appears with green styling
   - Summary shows total, successful, and failed counts
   - Process button becomes enabled again

7. Test error handling:
   - Start processing with invalid path
   - Verify error message appears in console
   - Verify component handles error gracefully
  </how-to-verify>
  <resume-signal>Type "approved" if all features work, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. Progress component installed and striped animation CSS added
2. useSseConnection hook wraps fetch-event-source properly
3. ProcessingProgress shows percentage with animated striped bar
4. ProcessingProgress displays current EPUB filename
5. ProcessingProgress calculates and displays ETA
6. SSE connection receives progress events in real-time
7. ProcessingProgress transforms to CompletionSummary on completion
8. CompletionSummary shows results with success styling
9. App.tsx integrates components with proper state management
10. SSE connections cleanup properly on unmount
</verification>

<success_criteria>
Phase 6 Plan 4 is complete when:
1. User sees animated striped progress bar during processing
2. User sees percentage completion (current/total)
3. User sees current EPUB filename below progress bar
4. User sees ETA calculation that updates in real-time
5. Progress updates via SSE connection (no polling)
6. On completion, progress transforms to summary card
7. Summary card shows total, successful, and failed counts
8. SSE connection uses fetch-event-source library
9. Connections cleanup on component unmount
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-upload-tokenizer-selection/06-04-SUMMARY.md`
</output>
