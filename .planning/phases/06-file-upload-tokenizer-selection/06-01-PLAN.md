---
phase: 06-file-upload-tokenizer-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/components/tokenizer/TokenizerSelector.tsx
  - web/src/components/tokenizer/HFModelCombobox.tsx
  - web/src/components/tokenizer/ModelInfoCard.tsx
  - web/src/hooks/use-local-storage.ts
autonomous: false

must_haves:
  truths:
    - "User can select GPT-4 tokenizer via clickable chip (toggles on/off)"
    - "User can select Claude tokenizer via clickable chip (toggles on/off)"
    - "User can search and select Hugging Face models via searchable dropdown"
    - "User sees model info card with vocabulary size and HF model card link on hover"
    - "User sees selected tokenizers as list with remove buttons"
    - "UI validates at least one tokenizer is selected (shows error if none selected)"
    - "Last selected tokenizers are remembered in localStorage and restored on page load"
  artifacts:
    - path: "web/src/components/tokenizer/TokenizerSelector.tsx"
      provides: "ToggleGroup-based tokenizer selection UI"
      min_lines: 60
    - path: "web/src/components/tokenizer/HFModelCombobox.tsx"
      provides: "Searchable dropdown for HF model selection"
      min_lines: 80
    - path: "web/src/components/tokenizer/ModelInfoCard.tsx"
      provides: "HoverCard content showing model details"
      min_lines: 30
    - path: "web/src/hooks/use-local-storage.ts"
      provides: "Custom localStorage hook for persistence"
      min_lines: 25
    - path: "web/src/components/ui/toggle-group.tsx"
      provides: "shadcn/ui ToggleGroup component"
      exports: ["ToggleGroup", "ToggleGroupItem"]
  key_links:
    - from: "web/src/components/tokenizer/TokenizerSelector.tsx"
      to: "/api/list-models"
      via: "fetch in useEffect"
      pattern: "fetch.*api/list-models"
    - from: "web/src/components/tokenizer/TokenizerSelector.tsx"
      to: "web/src/hooks/use-local-storage.ts"
      via: "import useLocalStorage hook"
      pattern: "useLocalStorage"
    - from: "web/src/components/tokenizer/HFModelCombobox.tsx"
      to: "web/src/components/tokenizer/ModelInfoCard.tsx"
      via: "HoverCard wrapper"
      pattern: "HoverCard.*ModelInfoCard"
---

<objective>
Create tokenizer selection UI with ToggleGroup chips for GPT-4/Claude, Combobox for Hugging Face models, and localStorage persistence.

Purpose: Provide users with an intuitive interface for selecting tokenizers that remembers their preferences across sessions.

Output: Working tokenizer selector component with multi-select chips, searchable HF model dropdown, model info cards, and localStorage persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-upload-tokenizer-selection/06-CONTEXT.md
@.planning/phases/06-file-upload-tokenizer-selection/06-RESEARCH.md
@.planning/phases/05-backend-api-file-processing/05-01-SUMMARY.md

# API Endpoints Available (from Phase 5)
- GET /api/list-models — Returns TokenizerInfo[] with id, name, description, async fields
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui components and dependencies</name>
  <files>web/package.json, web/src/components/ui/toggle-group.tsx, web/src/components/ui/combobox.tsx, web/src/components/ui/command.tsx, web/src/components/ui/popover.tsx, web/src/components/ui/hover-card.tsx, web/src/components/ui/badge.tsx, web/src/components/ui/sonner.tsx</files>
  <action>
Install required shadcn/ui components and dependencies:

1. Install shadcn/ui components:
```bash
cd web
npx shadcn@latest add sonner
npx shadcn@latest add toggle-group
npx shadcn@latest add combobox
npx shadcn@latest add command
npx shadcn@latest add popover
npx shadcn@latest add hover-card
npx shadcn@latest add badge
```

2. Install @microsoft/fetch-event-source for SSE (will be used in 06-04):
```bash
npm install @microsoft/fetch-event-source
```

3. Add Toaster to web/src/main.tsx for Sonner support:
```tsx
import { Toaster } from "@/components/ui/sonner"

// In the return:
<Toaster />
```

Do NOT create custom components - use shadcn/ui CLI which generates files in src/components/ui/.
  </action>
  <verify>ls web/src/components/ui/ shows toggle-group.tsx, combobox.tsx, command.tsx, popover.tsx, hover-card.tsx, badge.tsx, sonner.tsx</verify>
  <done>All required shadcn/ui components installed and Toaster added to main.tsx</done>
</task>

<task type="auto">
  <name>Task 2: Create useLocalStorage hook for persistence</name>
  <files>web/src/hooks/use-local-storage.ts</files>
  <action>
Create custom useLocalStorage hook following the pattern from 06-RESEARCH.md:

```typescript
// web/src/hooks/use-local-storage.ts
import { useState, useCallback } from 'react'

export function useLocalStorage<T>(key: string, initialValue: T) {
  // Get stored value or use initial
  const [storedValue, setStoredValue] = useState<T>(() => {
    if (typeof window === 'undefined') return initialValue
    try {
      const item = window.localStorage.getItem(key)
      return item ? JSON.parse(item) : initialValue
    } catch (error) {
      console.error(`Error loading ${key} from localStorage:`, error)
      return initialValue
    }
  })

  // Update localStorage when state changes
  const setValue = useCallback((value: T | ((val: T) => T)) => {
    try {
      const valueToStore = value instanceof Function ? value(storedValue) : value
      setStoredValue(valueToStore)
      if (typeof window !== 'undefined') {
        window.localStorage.setItem(key, JSON.stringify(valueToStore))
      }
    } catch (error) {
      console.error(`Error setting ${key} in localStorage:`, error)
    }
  }, [key, storedValue])

  return [storedValue, setValue] as const
}
```

Pattern source: 06-RESEARCH.md "Pattern 1: Custom useLocalStorage Hook"
  </action>
  <verify>web/src/hooks/use-local-storage.ts exists and exports useLocalStorage function</verify>
  <done>useLocalStorage hook created with proper TypeScript typing and error handling</done>
</task>

<task type="auto">
  <name>Task 3: Create ModelInfoCard component for HF model details</name>
  <files>web/src/components/tokenizer/ModelInfoCard.tsx</files>
  <action>
Create ModelInfoCard component that displays Hugging Face model details:

```typescript
// web/src/components/tokenizer/ModelInfoCard.tsx
import type { TokenizerInfo } from '@epub-counter/shared'
import { Badge } from "@/components/ui/badge"

interface ModelInfoCardProps {
  model: TokenizerInfo
}

export function ModelInfoCard({ model }: ModelInfoCardProps) {
  return (
    <div className="space-y-2 p-3">
      <div className="flex items-center gap-2">
        <h4 className="font-semibold text-sm">{model.name}</h4>
        {model.async && (
          <Badge variant="secondary" className="text-xs">
            Async
          </Badge>
        )}
      </div>
      <p className="text-xs text-muted-foreground">{model.description}</p>
      <div className="text-xs text-muted-foreground">
        <span className="font-medium">ID:</span> {model.id}
      </div>
      {model.id.startsWith('hf:') && (
        <a
          href={`https://huggingface.co/${model.id.replace('hf:', '')}`}
          target="_blank"
          rel="noopener noreferrer"
          className="text-xs text-primary hover:underline"
        >
          View on Hugging Face →
        </a>
      )}
    </div>
  )
}
```

Use TokenizerInfo type from @epub-counter/shared package.
  </action>
  <verify>web/src/components/tokenizer/ModelInfoCard.tsx exists and exports ModelInfoCard component</verify>
  <done>ModelInfoCard component created showing model name, async badge, description, and HF link</done>
</task>

<task type="auto">
  <name>Task 4: Create HFModelCombobox for searchable HF model selection</name>
  <files>web/src/components/tokenizer/HFModelCombobox.tsx</files>
  <action>
Create HFModelCombobox component using Popover + Command pattern:

```typescript
// web/src/components/tokenizer/HFModelCombobox.tsx
import * as React from "react"
import { Check, ChevronsUpDown } from "lucide-react"
import { Button } from "@/components/ui/button"
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
} from "@/components/ui/command"
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover"
import { HoverCard, HoverCardTrigger, HoverCardContent } from "@/components/ui/hover-card"
import { ModelInfoCard } from "./ModelInfoCard"
import type { TokenizerInfo } from '@epub-counter/shared'

interface HFModelComboboxProps {
  models: TokenizerInfo[]
  selectedModels: string[]
  onSelectionChange: (models: string[]) => void
}

export function HFModelCombobox({ models, selectedModels, onSelectionChange }: HFModelComboboxProps) {
  const [open, setOpen] = React.useState(false)

  const hfModels = models.filter(m => m.id.startsWith('hf:'))

  const toggleModel = (modelId: string) => {
    if (selectedModels.includes(modelId)) {
      onSelectionChange(selectedModels.filter(m => m !== modelId))
    } else {
      onSelectionChange([...selectedModels, modelId])
    }
  }

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          role="combobox"
          aria-expanded={open}
          className="w-full justify-between"
        >
          {selectedModels.length > 0
            ? `${selectedModels.length} HF model${selectedModels.length > 1 ? 's' : ''} selected`
            : "Select Hugging Face models..."}
          <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-full p-0" align="start">
        <Command>
          <CommandInput placeholder="Search Hugging Face models..." />
          <CommandList>
            <CommandEmpty>No model found.</CommandEmpty>
            <CommandGroup>
              {hfModels.map((model) => (
                <HoverCard key={model.id}>
                  <HoverCardTrigger asChild>
                    <CommandItem
                      value={`${model.id} ${model.name}`}
                      onSelect={() => toggleModel(model.id)}
                    >
                      <Check
                        className={cn(
                          "mr-2 h-4 w-4",
                          selectedModels.includes(model.id) ? "opacity-100" : "opacity-0"
                        )}
                      />
                      <span className="flex-1">{model.name}</span>
                    </CommandItem>
                  </HoverCardTrigger>
                  <HoverCardContent side="right" align="start" className="w-80">
                    <ModelInfoCard model={model} />
                  </HoverCardContent>
                </HoverCard>
              ))}
            </CommandGroup>
          </CommandList>
        </Command>
      </PopoverContent>
    </Popover>
  )
}
```

Add cn utility import from @/lib/utils if not present.
  </action>
  <verify>web/src/components/tokenizer/HFModelCombobox.tsx exists and exports HFModelCombobox component</verify>
  <done>HFModelCombobox created with search, hover cards, and multi-select functionality</done>
</task>

<task type="auto">
  <name>Task 5: Create TokenizerSelector component with ToggleGroup and localStorage</name>
  <files>web/src/components/tokenizer/TokenizerSelector.tsx</files>
  <action>
Create TokenizerSelector component that combines GPT-4/Claude ToggleGroup chips with HFModelCombobox:

```typescript
// web/src/components/tokenizer/TokenizerSelector.tsx
import { useEffect, useState } from 'react'
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { X } from "lucide-react"
import { HFModelCombobox } from "./HFModelCombobox"
import { useLocalStorage } from "@/hooks/use-local-storage"
import type { TokenizerInfo } from '@epub-counter/shared'
import { toast } from "sonner"

const STANDARD_TOKENIZERS = ['gpt4', 'claude'] as const

export function TokenizerSelector() {
  const [allModels, setAllModels] = useState<TokenizerInfo[]>([])
  const [selectedTokenizers, setSelectedTokenizers] = useLocalStorage<string[]>(
    'selected-tokenizers',
    ['gpt4', 'claude'] // Default to GPT-4 and Claude
  )

  useEffect(() => {
    // Fetch available models from API
    fetch('http://localhost:8787/api/list-models')
      .then(res => res.json())
      .then((data) => {
        if (data.success) {
          setAllModels(data.data)
        } else {
          toast.error('Failed to load tokenizers')
        }
      })
      .catch(() => toast.error('Failed to connect to server'))
  }, [])

  const standardTokenizers = allModels.filter(m =>
    STANDARD_TOKENIZERS.includes(m.id as any)
  )

  const selectedStandard = selectedTokenizers.filter(t =>
    STANDARD_TOKENIZERS.includes(t as any)
  )

  const selectedHF = selectedTokenizers.filter(t => t.startsWith('hf:'))

  const toggleStandard = (value: string[]) => {
    // Remove standard tokenizers from selection, add new selection
    const otherTokenizers = selectedTokenizers.filter(t => !STANDARD_TOKENIZERS.includes(t as any))
    setSelectedTokenizers([...otherTokenizers, ...value])
  }

  const removeHF = (modelId: string) => {
    setSelectedTokenizers(selectedTokenizers.filter(t => t !== modelId))
  }

  const hasSelection = selectedTokenizers.length > 0

  return (
    <div className="space-y-4">
      <div>
        <label className="text-sm font-medium mb-2 block">Select Tokenizers</label>
        <p className="text-xs text-muted-foreground mb-3">
          Choose at least one tokenizer for EPUB processing
        </p>
      </div>

      {/* Standard tokenizers (GPT-4, Claude) */}
      <div>
        <label className="text-xs font-medium text-muted-foreground mb-2 block">
          Standard Tokenizers
        </label>
        <ToggleGroup
          type="multiple"
          value={selectedStandard}
          onValueChange={toggleStandard}
          variant="outline"
          className="flex flex-wrap gap-2"
        >
          {standardTokenizers.map((tokenizer) => (
            <ToggleGroupItem
              key={tokenizer.id}
              value={tokenizer.id}
              aria-label={`Select ${tokenizer.name}`}
              className="px-4 py-2"
            >
              {tokenizer.name}
            </ToggleGroupItem>
          ))}
        </ToggleGroup>
      </div>

      {/* Hugging Face models */}
      <div>
        <label className="text-xs font-medium text-muted-foreground mb-2 block">
          Hugging Face Models
        </label>
        <HFModelCombobox
          models={allModels}
          selectedModels={selectedHF}
          onSelectionChange={(hfModels) => {
            // Replace HF selection
            const nonHF = selectedTokenizers.filter(t => !t.startsWith('hf:'))
            setSelectedTokenizers([...nonHF, ...hfModels])
          }}
        />
      </div>

      {/* Selected HF models as badges */}
      {selectedHF.length > 0 && (
        <div>
          <label className="text-xs font-medium text-muted-foreground mb-2 block">
            Selected HF Models
          </label>
          <div className="flex flex-wrap gap-2">
            {selectedHF.map((modelId) => {
              const model = allModels.find(m => m.id === modelId)
              return (
                <Badge key={modelId} variant="secondary" className="gap-1 pr-1">
                  {model?.name || modelId}
                  <Button
                    variant="ghost"
                    size="sm"
                    className="h-auto p-0 hover:bg-transparent"
                    onClick={() => removeHF(modelId)}
                  >
                    <X className="h-3 w-3" />
                  </Button>
                </Badge>
              )
            })}
          </div>
        </div>
      )}

      {/* Validation message */}
      {!hasSelection && (
        <p className="text-sm text-destructive">
          Please select at least one tokenizer
        </p>
      )}

      {/* Summary */}
      {hasSelection && (
        <p className="text-xs text-muted-foreground">
          {selectedTokenizers.length} tokenizer{selectedTokenizers.length > 1 ? 's' : ''} selected
        </p>
      )}
    </div>
  )
}
```

Component should:
- Fetch models from GET /api/list-models
- Use localStorage via useLocalStorage hook
- Show validation error if no tokenizers selected
- Display selected HF models as removable badges
- Use Sonner for error toasts
  </action>
  <verify>web/src/components/tokenizer/TokenizerSelector.tsx exists and exports TokenizerSelector component</verify>
  <done>TokenizerSelector created with ToggleGroup, HFModelCombobox integration, localStorage persistence, and validation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete tokenizer selection UI with ToggleGroup chips for GPT-4/Claude, searchable HF model dropdown with hover cards, selected model badges with remove buttons, and localStorage persistence</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev` from project root
2. Open http://localhost:5173 in browser
3. Create a test component in App.tsx to render TokenizerSelector:
```tsx
import { TokenizerSelector } from "./components/tokenizer/TokenizerSelector"

function App() {
  return (
    <div className="min-h-screen bg-background p-8">
      <div className="max-w-2xl mx-auto">
        <h1 className="text-2xl font-bold mb-6">Tokenizer Selection Test</h1>
        <TokenizerSelector />
      </div>
    </div>
  )
}
```
4. Verify the following:
   - GPT-4 and Claude chips are clickable and toggle on/off
   - Hugging Face dropdown opens and shows searchable list
   - Typing in search filters the HF model list
   - Hovering over HF models shows info card with details
   - Selecting HF models adds them as badges below
   - Clicking X on HF badges removes them
   - "Please select at least one tokenizer" appears when none selected
   - Refreshing the page remembers your selections
   - Console shows no errors
5. Check browser DevTools > Application > Local Storage to confirm 'selected-tokenizers' key is saved
  </how-to-verify>
  <resume-signal>Type "approved" if all features work, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. All shadcn/ui components installed (toggle-group, combobox, command, popover, hover-card, badge, sonner)
2. useLocalStorage hook created with proper error handling
3. ModelInfoCard displays model details correctly
4. HFModelCombobox provides searchable dropdown with hover cards
5. TokenizerSelector combines all components with localStorage persistence
6. API call to /api/list-models succeeds
7. Validation shows error when no tokenizers selected
8. Selection persists across page reloads
</verification>

<success_criteria>
Phase 6 Plan 1 is complete when:
1. User can toggle GPT-4 and Claude via chips (visual state changes)
2. User can search and select HF models via dropdown
3. User sees model info on hover for HF models
4. User sees selected HF models as removable badges
5. User sees validation message when no tokenizers selected
6. User's selections persist after page refresh (localStorage)
7. Component fetches models from API without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-upload-tokenizer-selection/06-01-SUMMARY.md`
</output>
