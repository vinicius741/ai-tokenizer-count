---
phase: 06-file-upload-tokenizer-selection
plan: 03
type: execute
wave: 2
depends_on: [06-01, 06-02]
files_modified:
  - web/src/components/processing/FolderInput.tsx
  - web/src/components/processing/ProcessButton.tsx
  - web/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can input EPUB folder path via text input field"
    - "Folder path is displayed read-only after selection"
    - "Process button is disabled until tokenizers selected AND folder path entered"
    - "Process button becomes enabled when both conditions are met"
    - "Clicking Process button calls POST /api/process with folder path and tokenizers"
    - "API call returns jobId which is passed to parent component"
    - "Loading state shown on Process button during API call"
  artifacts:
    - path: "web/src/components/processing/FolderInput.tsx"
      provides: "Folder path input with read-only display after selection"
      min_lines: 40
    - path: "web/src/components/processing/ProcessButton.tsx"
      provides: "Process button with conditional enable and loading states"
      min_lines: 60
  key_links:
    - from: "web/src/components/processing/ProcessButton.tsx"
      to: "POST /api/process"
      via: "fetch with POST method"
      pattern: "fetch.*api/process.*method.*POST"
    - from: "web/src/components/processing/ProcessButton.tsx"
      to: "06-01 TokenizerSelector"
      via: "props for selected tokenizers"
      pattern: "selectedTokenizers.*props"
    - from: "web/src/components/processing/FolderInput.tsx"
      to: "06-03 ProcessButton"
      via: "folderPath state"
      pattern: "folderPath.*useState"
---

<objective>
Create EPUB folder input interface and process button with conditional enable logic and API integration.

Purpose: Allow users to input server-side EPUB folder path and trigger processing with selected tokenizers.

Output: Working folder input component and process button with API integration and loading states.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-upload-tokenizer-selection/06-CONTEXT.md
@.planning/phases/06-file-upload-tokenizer-selection/06-RESEARCH.md
@.planning/phases/05-backend-api-file-processing/05-03-SUMMARY.md

# API Endpoint (from Phase 5)
- POST /api/process â€” Accepts { inputPath: string, tokenizerList: string[] }, returns { jobId: string }

# Context Decisions
- Folder picker for server-side paths is "Claude's discretion" area
- Browsers cannot pick server-side folders directly
- Simple text input is most straightforward approach for localhost development
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FolderInput component with path display</name>
  <files>web/src/components/processing/FolderInput.tsx</files>
  <action>
Create FolderInput component for entering EPUB folder path:

```typescript
// web/src/components/processing/FolderInput.tsx
import { useState } from 'react'
import { FolderOpen, Edit2, Check } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { cn } from '@/lib/utils'

interface FolderInputProps {
  value: string
  onChange: (path: string) => void
}

export function FolderInput({ value, onChange }: FolderInputProps) {
  const [isEditing, setIsEditing] = useState(false)
  const [tempPath, setTempPath] = useState(value)

  const handleSave = () => {
    onChange(tempPath)
    setIsEditing(false)
  }

  const handleCancel = () => {
    setTempPath(value)
    setIsEditing(false)
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleSave()
    } else if (e.key === 'Escape') {
      handleCancel()
    }
  }

  if (isEditing) {
    return (
      <div className="flex items-center gap-2">
        <Input
          value={tempPath}
          onChange={(e) => setTempPath(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder="/path/to/epubs"
          className="flex-1"
          autoFocus
        />
        <Button size="sm" variant="ghost" onClick={handleSave}>
          <Check className="h-4 w-4" />
        </Button>
        <Button size="sm" variant="ghost" onClick={handleCancel}>
          <Edit2 className="h-4 w-4" />
        </Button>
      </div>
    )
  }

  return (
    <div
      className={cn(
        "flex items-center gap-2 p-3 border rounded-md transition-colors",
        value ? "border-border bg-background" : "border-muted-foreground/25"
      )}
    >
      <FolderOpen className={cn(
        "h-4 w-4",
        value ? "text-foreground" : "text-muted-foreground"
      )} />
      {value ? (
        <span className="flex-1 text-sm font-mono truncate">{value}</span>
      ) : (
        <span className="flex-1 text-sm text-muted-foreground">
          Enter EPUB folder path
        </span>
      )}
      <Button
        size="sm"
        variant="ghost"
        onClick={() => setIsEditing(true)}
        className="h-8 w-8 p-0"
      >
        <Edit2 className="h-4 w-4" />
      </Button>
    </div>
  )
}
```

Install shadcn/ui Input component if not present:
```bash
cd web && npx shadcn@latest add input
```

Component should:
- Show folder path read-only when not editing
- Allow editing via edit button
- Save on Enter or check button
- Cancel on Escape or edit button
- Show placeholder when empty
  </action>
  <verify>web/src/components/processing/FolderInput.tsx exists and exports FolderInput component</verify>
  <done>FolderInput created with edit mode, read-only display, and keyboard shortcuts</done>
</task>

<task type="auto">
  <name>Task 2: Create ProcessButton with API integration</name>
  <files>web/src/components/processing/ProcessButton.tsx</files>
  <action>
Create ProcessButton component with conditional enable and API call:

```typescript
// web/src/components/processing/ProcessButton.tsx
import { useState } from 'react'
import { Loader2 } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { toast } from 'sonner'

interface ProcessButtonProps {
  folderPath: string
  selectedTokenizers: string[]
  onJobStarted: (jobId: string) => void
  disabled?: boolean
}

export function ProcessButton({
  folderPath,
  selectedTokenizers,
  onJobStarted,
  disabled: externallyDisabled
}: ProcessButtonProps) {
  const [isLoading, setIsLoading] = useState(false)

  // Button is disabled if:
  // - Externally disabled
  // - No folder path
  // - No tokenizers selected
  // - Currently loading
  const isDisabled =
    externallyDisabled ||
    !folderPath.trim() ||
    selectedTokenizers.length === 0 ||
    isLoading

  const handleClick = async () => {
    if (isDisabled) return

    setIsLoading(true)

    try {
      const response = await fetch('http://localhost:8787/api/process', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          inputPath: folderPath,
          tokenizerList: selectedTokenizers,
        }),
      })

      const data = await response.json()

      if (!response.ok || !data.success) {
        throw new Error(data.error?.message || 'Failed to start processing')
      }

      toast.success('Processing started', {
        description: `Job ID: ${data.data.jobId}`
      })

      onJobStarted(data.data.jobId)
    } catch (error) {
      toast.error('Failed to start processing', {
        description: error instanceof Error ? error.message : 'Unknown error'
      })
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Button
      onClick={handleClick}
      disabled={isDisabled}
      className="w-full"
      size="lg"
    >
      {isLoading ? (
        <>
          <Loader2 className="mr-2 h-4 w-4 animate-spin" />
          Starting...
        </>
      ) : (
        'Process EPUBs'
      )}
    </Button>
  )
}
```

Component should:
- Be disabled when folderPath is empty or tokenizers empty
- Show loading spinner during API call
- Call POST /api/process with inputPath and tokenizerList
- Pass jobId to parent via onJobStarted callback
- Show error toast on API failure
- Show success toast with jobId
  </action>
  <verify>web/src/components/processing/ProcessButton.tsx exists and exports ProcessButton component</verify>
  <done>ProcessButton created with conditional enable, API integration, and loading states</done>
</task>

<task type="auto">
  <name>Task 3: Update App.tsx to integrate tokenizer selection, file upload, and processing controls</name>
  <files>web/src/App.tsx</files>
  <action>
Update App.tsx to integrate TokenizerSelector, FileDropzone, FolderInput, and ProcessButton:

```typescript
// web/src/App.tsx
import { useState } from 'react'
import { TokenizerSelector } from './components/tokenizer/TokenizerSelector'
import { FileDropzone } from './components/file-upload/FileDropzone'
import { FolderInput } from './components/processing/FolderInput'
import { ProcessButton } from './components/processing/ProcessButton'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import type { ResultsOutput } from '@epub-counter/shared'

function App() {
  const [uploadedResults, setUploadedResults] = useState<ResultsOutput | null>(null)
  const [currentJobId, setCurrentJobId] = useState<string | null>(null)
  const [folderPath, setFolderPath] = useState('')

  // This will be connected to tokenizer selector in the full integration
  // For now, using placeholder state
  const [selectedTokenizers, setSelectedTokenizers] = useState<string[]>([])

  const handleFileLoaded = (data: ResultsOutput, fileName: string) => {
    setUploadedResults(data)
    console.log('Uploaded results:', fileName, data)
  }

  const handleJobStarted = (jobId: string) => {
    setCurrentJobId(jobId)
    console.log('Job started:', jobId)
  }

  return (
    <div className="min-h-screen bg-background p-8">
      <div className="max-w-2xl mx-auto space-y-6">
        <Card>
          <CardHeader>
            <CardTitle>EPUB Tokenizer Counter</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            {/* Tokenizer Selection */}
            <div>
              <h2 className="text-lg font-semibold mb-4">1. Select Tokenizers</h2>
              <TokenizerSelector />
            </div>

            {/* File Upload OR Folder Input */}
            <div>
              <h2 className="text-lg font-semibold mb-4">2. Choose Input Source</h2>
              <div className="space-y-4">
                <div>
                  <label className="text-sm font-medium mb-2 block">
                    Upload existing results.json
                  </label>
                  <FileDropzone onFileLoaded={handleFileLoaded} />
                </div>

                <div className="relative">
                  <div className="absolute inset-0 flex items-center">
                    <span className="w-full border-t" />
                  </div>
                  <div className="relative flex justify-center text-xs uppercase">
                    <span className="bg-background px-2 text-muted-foreground">
                      Or process new EPUBs
                    </span>
                  </div>
                </div>

                <div>
                  <label className="text-sm font-medium mb-2 block">
                    EPUB folder path (server-side)
                  </label>
                  <FolderInput
                    value={folderPath}
                    onChange={setFolderPath}
                  />
                </div>
              </div>
            </div>

            {/* Process Button */}
            <div>
              <ProcessButton
                folderPath={folderPath}
                selectedTokenizers={selectedTokenizers}
                onJobStarted={handleJobStarted}
              />
            </div>
          </CardContent>
        </Card>

        {/* Debug Info - Remove in production */}
        {currentJobId && (
          <Card>
            <CardContent className="pt-6">
              <p className="text-sm">Current Job ID: {currentJobId}</p>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  )
}

export default App
```

App should:
- Combine all components in a logical layout
- Show tokenizer selector at top
- Show file upload OR folder input options
- Show process button at bottom
- Display current job ID for debugging
  </action>
  <verify>web/src/App.tsx updated with TokenizerSelector, FileDropzone, FolderInput, and ProcessButton components</verify>
  <done>App.tsx integrates all components with proper state management and layout</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete processing controls interface with folder input and process button that integrates with tokenizer selection and file upload components</what-built>
  <how-to-verify>
1. Start both servers: `npm run dev` from project root
2. Open http://localhost:5173 in browser
3. Verify the interface displays:
   - Tokenizer selection section with GPT-4/Claude chips and HF model dropdown
   - File upload drop zone
   - "Or process new EPUBs" divider
   - Folder input field
   - Process button

4. Test FolderInput:
   - Click edit button and verify input appears
   - Type a path like "./epubs" or "/absolute/path/to/epubs"
   - Press Enter and verify path is saved and shown read-only
   - Click edit again and verify you can change the path

5. Test ProcessButton conditional enable:
   - Verify button is disabled when no folder path
   - Verify button is disabled when no tokenizers selected
   - Select GPT-4 tokenizer and verify still disabled (no path)
   - Enter folder path and verify button becomes enabled
   - Deselect all tokenizers and verify button becomes disabled

6. Test API integration (requires backend running):
   - Select at least one tokenizer
   - Enter a valid EPUB folder path
   - Click "Process EPUBs" button
   - Verify loading spinner appears
   - Check browser console for API response
   - Verify success toast appears with jobId
   - Verify "Current Job ID" card appears at bottom

7. Test error handling:
   - Enter invalid path (e.g., "/nonexistent/path")
   - Click Process button
   - Verify error toast appears
  </how-to-verify>
  <resume-signal>Type "approved" if all features work, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. FolderInput shows edit mode on click, read-only otherwise
2. FolderInput supports Enter to save and Escape to cancel
3. ProcessButton is disabled when folderPath is empty
4. ProcessButton is disabled when selectedTokenizers is empty
5. ProcessButton becomes enabled when both conditions are met
6. ProcessButton shows loading spinner during API call
7. POST /api/process is called with correct body format
8. Success/error toasts appear appropriately
9. JobId is passed to parent component
10. App.tsx integrates all components in logical layout
</verification>

<success_criteria>
Phase 6 Plan 3 is complete when:
1. User can enter folder path via FolderInput component
2. User can edit folder path after entering it
3. Process button is disabled when no folder path
4. Process button is disabled when no tokenizers selected
5. Process button enables when both folder and tokenizers provided
6. Clicking Process calls POST /api/process with correct data
7. Loading state shown during API call
8. Success/error messages shown as toasts
9. JobId is returned and displayed
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-upload-tokenizer-selection/06-03-SUMMARY.md`
</output>
