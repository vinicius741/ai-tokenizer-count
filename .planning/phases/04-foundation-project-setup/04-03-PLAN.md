---
phase: 04-foundation-project-setup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - server/package.json
  - server/tsconfig.json
  - server/src/server.ts
  - package.json
autonomous: false

must_haves:
  truths:
    - "User can run npm run dev:server and see Fastify server start on port 8787"
    - "User can visit http://localhost:8787/api/health and receive {\"status\":\"ok\"} response"
    - "CORS is configured allowing requests from frontend (localhost:5173)"
    - "Server logs all requests via Fastify logger"
  artifacts:
    - path: "server/package.json"
      provides: "Backend package configuration with Fastify dependencies"
      contains: ["\"fastify\":", "\"@fastify/cors\":", "\"tsx\":", "\"type\": \"module\""]
    - path: "server/tsconfig.json"
      provides: "TypeScript configuration for Fastify server"
      contains: ["\"module\": \"ESNext\"", "\"moduleResolution\": \"bundler\""]
    - path: "server/src/server.ts"
      provides: "Fastify server entry point"
      contains: ["Fastify({", "listen({ port: 8787", "get('/api/health'"]
  key_links:
    - from: "server/src/server.ts"
      to: "http://localhost:8787/api/health"
      via: "Fastify route handler"
      pattern: "fastify.get.*'/api/health'"
    - from: "web/vite.config.ts"
      to: "server/src/server.ts"
      via: "Vite proxy configuration"
      pattern: "proxy.*target.*8787"
    - from: "server/src/server.ts"
      to: "web/"
      via: "CORS configuration"
      pattern: "cors.*origin"
---

<objective>
Create the Fastify backend server with TypeScript, CORS configuration, and health check endpoint. This establishes the API server that will handle EPUB processing requests.

Purpose: Fastify provides high performance and excellent TypeScript support, CORS enables frontend-backend communication, health check endpoint verifies connectivity.

Output: Functional Fastify server running on port 8787 with CORS enabled and /api/health endpoint responding.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation-project-setup/04-CONTEXT.md
@.planning/phases/04-foundation-project-setup/04-RESEARCH.md

# Existing codebase patterns
@/package.json
@/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Create server directory structure and package.json</name>
  <files>server/package.json, server/tsconfig.json, server/src/server.ts</files>
  <action>
Create server/ directory with TypeScript package configuration:

1. Create server/ directory
2. Create server/package.json:
```json
{
  "name": "server",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "tsx watch src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js"
  },
  "dependencies": {
    "fastify": "^5.7.0",
    "@fastify/cors": "^10.0.0"
  },
  "devDependencies": {
    "@types/node": "^22.0.0",
    "typescript": "^5.6.0",
    "tsx": "^4.19.0"
  }
}
```

3. Create server/tsconfig.json:
```json
{
  "extends": "../tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "esModuleInterop": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

4. Create server/src/ directory
  </action>
  <verify>
ls -la server/ shows package.json, tsconfig.json, src/
cat server/package.json | grep -E '"fastify"|"tsx"'
cat server/tsconfig.json | grep "extends"
  </verify>
  <done>
Server directory created with package.json, tsconfig.json extending root config
  </done>
</task>

<task type="auto">
  <name>Create Fastify server with CORS and health check</name>
  <files>server/src/server.ts</files>
  <action>
Create server/src/server.ts:

```typescript
import Fastify from 'fastify'
import cors from '@fastify/cors'

const fastify = Fastify({
  logger: true,
})

// Register CORS for frontend communication
await fastify.register(cors, {
  origin: true, // Allow all origins in development
})

// Health check endpoint
fastify.get('/api/health', async () => {
  return { status: 'ok' }
})

// Start server
const start = async () => {
  try {
    await fastify.listen({ port: 8787, host: '0.0.0.0' })
  } catch (err) {
    fastify.log.error(err)
    process.exit(1)
  }
}

start()
```

Configure top-level await (ES2022+).
  </action>
  <verify>
cat server/src/server.ts | grep "Fastify({"
cat server/src/server.ts | grep "port: 8787"
cat server/src/server.ts | grep "'/api/health'"
cat server/src/server.ts | grep "cors"
  </verify>
  <done>
server.ts created with Fastify, CORS registration, /api/health endpoint
  </done>
</task>

<task type="auto">
  <name>Install server dependencies and update root scripts</name>
  <files>package.json, server/package.json, server/node_modules/</files>
  <action>
Install server dependencies and configure root workspace:

1. Update root package.json workspaces:
```json
{
  "workspaces": [
    "packages/shared",
    "web",
    "server"
  ]
}
```

2. Add dev:server script to root package.json (if not already added in plan 04-01):
```json
{
  "scripts": {
    "dev:server": "npm run dev --workspace=server"
  }
}
```

3. From root, run: `npm install`
4. Verify server/node_modules/ exists with fastify, @fastify/cors, tsx
  </action>
  <verify>
cat package.json | grep -A 3 '"workspaces"'
cat package.json | grep '"dev:server"'
ls server/node_modules/ | grep fastify
  </verify>
  <done>
Server dependencies installed via npm workspaces, root has dev:server script
  </done>
</task>

<task type="auto">
  <name>Verify Fastify server starts and health check responds</name>
  <files>server/src/server.ts</files>
  <action>
Start server and verify health check endpoint:

1. Start server: `npm run dev:server` from root
2. Wait for "Server listening at http://0.0.0.0:8787" log message
3. Test health endpoint: `curl http://localhost:8787/api/health`
4. Verify response: {"status":"ok"}
5. Check server logs show GET /api/health request
6. Stop server (Ctrl+C)

DO NOT proceed if health check fails or server errors on startup.
  </action>
  <verify>
curl -s http://localhost:8787/api/health
# Should output: {"status":"ok"}
  </verify>
  <done>
Fastify server runs on port 8787, /api/health returns {"status":"ok"}
  </done>
</task>

<task type="auto">
  <name>Verify CORS headers via curl</name>
  <files>server/src/server.ts</files>
  <action>
Verify CORS configuration is working by checking response headers:

1. Start server: `npm run dev:server` from root (if not running)
2. Run curl command to verify CORS headers:
   ```bash
   curl -I -H "Origin: http://localhost:5173" http://localhost:8787/api/health
   ```
3. Verify response includes CORS headers:
   - Access-Control-Allow-Origin: *
   - (or specific origin if not using origin: true)

4. Test actual OPTIONS preflight request:
   ```bash
   curl -X OPTIONS -H "Origin: http://localhost:5173" -H "Access-Control-Request-Method: GET" http://localhost:8787/api/health
   ```
5. Verify OPTIONS request returns 200 with appropriate CORS headers

Stop server after verification (Ctrl+C).
  </action>
  <verify>
curl -I -H "Origin: http://localhost:5173" http://localhost:8787/api/health 2>&1 | grep -i "access-control-allow"
# Should show Access-Control-Allow-Origin header
  </verify>
  <done>
CORS headers verified via curl, OPTIONS preflight returns 200
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Fastify backend server with CORS configuration and health check endpoint (CORS headers verified via curl)</what-built>
  <how-to-verify>
1. If not running, start both servers: `npm run dev` from root
2. Verify backend starts on port 8787 (check terminal output)
3. Test health endpoint in browser or curl:
   - Visit http://localhost:8787/api/health
   - Or run: curl http://localhost:8787/api/health
4. Verify response is: {"status":"ok"}
5. From frontend (http://localhost:5173 browser console), test CORS:
   - Open browser console
   - Run: fetch('http://localhost:8787/api/health').then(r => r.json()).then(console.log)
   - Verify response is {"status":"ok"} with no CORS errors
6. Check backend terminal shows GET /api/health request logged
  </how-to-verify>
  <resume-signal>Type "approved" if health check works and CORS allows frontend requests, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. npm run dev:server starts Fastify on port 8787
2. curl http://localhost:8787/api/health returns {"status":"ok"}
3. Frontend can call backend API without CORS errors
4. Server logs show request logging
5. Root package.json has workspaces configured
</verification>

<success_criteria>
- [ ] server/ directory exists with package.json and tsconfig.json
- [ ] Fastify and @fastify/cors installed
- [ ] npm run dev:server starts server on port 8787
- [ ] /api/health endpoint returns {"status":"ok"}
- [ ] CORS configured allowing frontend requests
- [ ] Root package.json has workspaces and dev:server script
- [ ] Both frontend and backend can run simultaneously with npm run dev
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation-project-setup/04-03-SUMMARY.md`
</output>
