---
phase: 04-foundation-project-setup
plan: 04
type: execute
wave: 2
depends_on: [04-01, 04-02, 04-03]
files_modified:
  - packages/shared/package.json
  - packages/shared/tsconfig.json
  - packages/shared/tsconfig.esm.json
  - packages/shared/tsconfig.cjs.json
  - packages/shared/src/index.ts
  - packages/shared/src/types.ts
  - packages/shared/dist/cjs/
  - packages/shared/dist/esm/
  - web/package.json
  - server/package.json
  - tsconfig.json
  - package.json
autonomous: true

must_haves:
  truths:
    - "Shared package builds successfully to both CJS and ESM formats"
    - "Frontend can import types from @epub-counter/shared without errors"
    - "Backend can import types from @epub-counter/shared without errors"
    - "npm run build compiles shared package to dist/cjs and dist/esm"
    - "npm run build --workspaces compiles shared package successfully"
  artifacts:
    - path: "packages/shared/package.json"
      provides: "Shared package configuration with dual CJS/ESM exports"
      contains: ["\"name\": \"@epub-counter/shared\"", "\"main\": \"./dist/cjs/index.js\"", "\"module\": \"./dist/esm/index.js\"", "\"exports\":"]
    - path: "packages/shared/tsconfig.json"
      provides: "Base TypeScript config extending root"
      contains: ["\"extends\": \"../../tsconfig.json\""]
    - path: "packages/shared/tsconfig.esm.json"
      provides: "ESM build configuration for frontend/bundlers"
      contains: ["\"module\": \"ESNext\"", "\"moduleResolution\": \"bundler\"", "\"outDir\": \"./dist/esm\""]
    - path: "packages/shared/tsconfig.cjs.json"
      provides: "CJS build configuration for Node.js backend"
      contains: ["\"module\": \"CommonJS\"", "\"moduleResolution\": \"node\"", "\"outDir\": \"./dist/cjs\""]
    - path: "packages/shared/src/types.ts"
      provides: "Shared TypeScript types/interfaces"
      contains: ["export interface", "EpubMetadata", "TokenCountResult"]
    - path: "packages/shared/src/index.ts"
      provides: "Main entry point exporting all shared code"
      contains: ["export * from './types'"]
    - path: "packages/shared/dist/cjs/index.js"
      provides: "CommonJS build output"
      exists: true
    - path: "packages/shared/dist/esm/index.js"
      provides: "ESM build output"
      exists: true
  key_links:
    - from: "web/src/App.tsx"
      to: "packages/shared/src/types.ts"
      via: "npm workspaces + TypeScript path mapping"
      pattern: "import.*from.*@epub-counter/shared"
    - from: "server/src/server.ts"
      to: "packages/shared/src/types.ts"
      via: "npm workspaces + TypeScript path mapping"
      pattern: "import.*from.*@epub-counter/shared"
    - from: "packages/shared/package.json"
      to: "tsconfig.json"
      via: "TypeScript paths configuration"
      pattern: "\"paths\".*\"@epub-counter/shared\""
---

<objective>
Create a shared TypeScript package for code reuse between frontend, backend, and CLI. The shared package produces dual CJS/ESM builds to work with both Node.js and bundler environments.

Purpose: Eliminates code duplication, ensures type consistency across all three interfaces (CLI, web UI, backend API), and allows business logic to be shared without copy-pasting.

Output: Functional @epub-counter/shared package with dual builds, importable by both frontend and backend.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation-project-setup/04-CONTEXT.md
@.planning/phases/04-foundation-project-setup/04-RESEARCH.md

# Prior plan outputs
@.planning/phases/04-foundation-project-setup/04-01-SUMMARY.md
@.planning/phases/04-foundation-project-setup/04-02-SUMMARY.md
@.planning/phases/04-foundation-project-setup/04-03-SUMMARY.md

# Existing codebase to reference
@/src/tokenizers/types.ts
@/src/epub/metadata.ts
</context>

<tasks>

<task type="auto">
  <name>Create shared package directory structure and configuration</name>
  <files>packages/shared/package.json, packages/shared/tsconfig.json, packages/shared/tsconfig.esm.json, packages/shared/tsconfig.cjs.json, packages/shared/src/</files>
  <action>
Create shared package structure with dual-build configuration:

1. Create packages/shared/ directory
2. Create packages/shared/src/ directory

3. Create packages/shared/package.json:
```json
{
  "name": "@epub-counter/shared",
  "version": "1.0.0",
  "type": "module",
  "main": "./dist/cjs/index.js",
  "module": "./dist/esm/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/esm/index.js",
      "require": "./dist/cjs/index.js"
    }
  },
  "scripts": {
    "build": "npm run build:esm && npm run build:cjs",
    "build:esm": "tsc -p tsconfig.esm.json",
    "build:cjs": "tsc -p tsconfig.cjs.json",
    "dev": "npm run build -- --watch"
  },
  "devDependencies": {
    "typescript": "^5.6.0"
  }
}
```

4. Create packages/shared/tsconfig.json (base config):
```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "declaration": true,
    "declarationMap": true,
    "esModuleInterop": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

5. Create packages/shared/tsconfig.esm.json (ESM for Vite):
```json
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist/esm",
    "module": "ESNext",
    "moduleResolution": "bundler"
  }
}
```

6. Create packages/shared/tsconfig.cjs.json (CJS for Node):
```json
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist/cjs",
    "module": "CommonJS",
    "moduleResolution": "node"
  }
}
```
  </action>
  <verify>
ls -la packages/shared/ shows package.json, tsconfig files, src/
cat packages/shared/package.json | grep -E '"name"|"exports"|"main"|"module"'
cat packages/shared/tsconfig.esm.json | grep "ESNext"
cat packages/shared/tsconfig.cjs.json | grep "CommonJS"
  </verify>
  <done>
Shared package directory created with dual-build TypeScript configuration
  </done>
</task>

<task type="auto">
  <name>Create shared types and main entry point</name>
  <files>packages/shared/src/types.ts, packages/shared/src/index.ts</files>
  <action>
Create shared TypeScript types and entry point:

1. Create packages/shared/src/types.ts with shared interfaces:
```typescript
// EPUB metadata types
export interface EpubMetadata {
  title: string;
  author: string;
  language?: string;
  filename: string;
  filepath: string;
}

// Token count result types
export interface TokenCountResult {
  filename: string;
  filepath: string;
  metadata: EpubMetadata;
  wordCount: number;
  tokens: Record<string, number>; // tokenizer name -> count
  errors?: string[];
}

// Processing options
export interface ProcessOptions {
  tokenizers: string[];
  maxMb: number;
  jobs: number;
  outputDir: string;
}

// Result schema version for compatibility tracking
export const SCHEMA_VERSION = "1.0" as const;

// Complete results output structure
export interface ResultsOutput {
  schema_version: string;
  processed_at: string;
  options: ProcessOptions;
  results: TokenCountResult[];
  summary: {
    total_files: number;
    successful: number;
    failed: number;
    total_words: number;
    token_totals: Record<string, number>;
  };
}

// Tokenizer type definitions
export type TokenizerType = 'gpt4' | 'claude' | `hf:${string}`;

export interface TokenizerInfo {
  id: TokenizerType;
  name: string;
  vocabulary_size?: number;
  provider: 'openai' | 'anthropic' | 'huggingface';
  description?: string;
}
```

2. Create packages/shared/src/index.ts (barrel export):
```typescript
// Re-export all types
export * from './types';

// Future exports when we migrate business logic:
// export * from './epub/parser';
// export * from './tokenizers';
```

DO NOT migrate existing CLI code yet - this plan only establishes the shared package structure.
  </action>
  <verify>
cat packages/shared/src/types.ts | grep "export interface"
cat packages/shared/src/index.ts | grep "export"
  </verify>
  <done>
Shared types defined in types.ts, exported via index.ts barrel file
  </done>
</task>

<task type="auto">
  <name>Configure npm workspaces and build scripts</name>
  <files>package.json, tsconfig.json, web/package.json, server/package.json</files>
  <action>
Configure root npm workspaces and TypeScript path mapping:

1. Update root package.json workspaces (verify already configured):
```json
{
  "workspaces": [
    "packages/shared",
    "web",
    "server"
  ],
  "scripts": {
    "dev": "concurrently \"npm run dev:web\" \"npm run dev:server\"",
    "dev:ui": "concurrently \"npm run dev:web\" \"npm run dev:server\"",
    "dev:web": "npm run dev --workspace=web",
    "dev:server": "npm run dev --workspace=server",
    "build": "npm run build --workspaces --if-present",
    "build:shared": "npm run build --workspace=packages/shared",
    "start": "node dist/cli/index.js",
    "postinstall": "npm run build:shared"
  }
}
```

Note: The combined "dev" script is now added here (in 04-04) because server from 04-03 now exists.

2. Update root tsconfig.json to add path mapping:
```json
{
  "compilerOptions": {
    // ... existing options ...
    "paths": {
      "@epub-counter/shared": ["./packages/shared/src"]
    }
  }
}
```

3. Add @epub-counter/shared as dependency to web/package.json and server/package.json:
```json
{
  "dependencies": {
    "@epub-counter/shared": "*"
  }
}
```

4. From root, run: `npm install` to link workspaces
  </action>
  <verify>
cat package.json | grep -A 5 '"workspaces"'
cat tsconfig.json | grep -A 3 '"paths"'
cat web/package.json | grep "@epub-counter/shared"
cat server/package.json | grep "@epub-counter/shared"
  </verify>
  <done>
npm workspaces configured, TypeScript paths mapped, shared package linked to frontend and backend, combined dev script added
  </done>
</task>

<task type="auto">
  <name>Build shared package and verify dual outputs</name>
  <files>packages/shared/dist/cjs/index.js, packages/shared/dist/esm/index.js</files>
  <action>
Build shared package and verify both CJS and ESM outputs:

1. From root, run: `npm run build:shared`
2. Verify both build outputs exist:
   - packages/shared/dist/cjs/index.js (CommonJS)
   - packages/shared/dist/esm/index.js (ESM)
   - packages/shared/dist/index.d.ts (type definitions)

3. Inspect CJS output - should NOT contain "export" keyword:
```bash
head -20 packages/shared/dist/cjs/index.js
```

4. Inspect ESM output - should contain "export" keyword:
```bash
head -20 packages/shared/dist/esm/index.js
```

5. Add postinstall hook to root package.json (if not present):
```json
{
  "scripts": {
    "postinstall": "npm run build:shared"
  }
}
```

This ensures shared package builds automatically after npm install.
  </action>
  <verify>
ls packages/shared/dist/cjs/index.js
ls packages/shared/dist/esm/index.js
grep "export" packages/shared/dist/esm/index.js | head -1
! grep "export" packages/shared/dist/cjs/index.js | head -1  # Should NOT find export
cat package.json | grep "postinstall"
  </verify>
  <done>
Shared package builds to both CJS and ESM formats, postinstall hook configured
  </done>
</task>

<task type="auto">
  <name>Test shared package imports from frontend and backend</name>
  <files>web/src/App.tsx, server/src/server.ts</files>
  <action>
Test that both frontend and backend can import from shared package:

1. Update web/src/App.tsx to test import:
Add at top of file: `import { TokenizerType, EpubMetadata } from '@epub-counter/shared'`

2. Update server/src/server.ts to test import:
Add after imports: `import { TokenizerType, ResultsOutput } from '@epub-counter/shared'`

3. From root, run: `npm run build:shared` (ensure shared builds first)

4. Start frontend: `npm run dev:web`
   - Verify no TypeScript errors about @epub-counter/shared
   - Check browser console for no import errors

5. Start backend: `npm run dev:server`
   - Verify no TypeScript errors
   - Check server starts without import errors

6. Test both running simultaneously: `npm run dev`

If imports fail, verify:
- npm install was run from root after adding workspaces
- TypeScript path mapping is correct in root tsconfig.json
- Shared package built successfully
  </action>
  <verify>
cat web/src/App.tsx | grep "from '@epub-counter/shared'"
cat server/src/server.ts | grep "from '@epub-counter/shared'"
# Verify both servers start without import errors
npm run build:shared  # Should succeed
  </verify>
  <done>
Frontend and backend both successfully import types from @epub-counter/shared
  </done>
</task>

<task type="auto">
  <name>Verify npm run build compiles both frontend and backend</name>
  <files>web/dist/, server/dist/, packages/shared/dist/</files>
  <action>
Verify that `npm run build` from root successfully compiles both frontend and backend (plus shared package):

1. From root, run: `npm run build`
   - This should trigger build for all workspaces that have build scripts
   - Expected: shared package builds to dist/cjs and dist/esm
   - Expected: web (Vite) builds to web/dist/
   - Expected: server (TypeScript) builds to server/dist/

2. Verify all build outputs exist:
   ```bash
   ls -la packages/shared/dist/cjs/index.js
   ls -la packages/shared/dist/esm/index.js
   ls -la web/dist/
   ls -la server/dist/
   ```

3. Verify no build errors in output

4. Test that production builds are valid:
   - Check web/dist/index.html exists
   - Check server/dist/server.js exists (compiled backend)

If build fails, note which workspace failed and why.
  </action>
  <verify>
npm run build
# Should exit with code 0
ls packages/shared/dist/cjs/index.js
ls packages/shared/dist/esm/index.js
ls web/dist/index.html
ls server/dist/server.js
# All outputs should exist
  </verify>
  <done>
npm run build compiles frontend (web), backend (server), and shared package without errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. packages/shared/ exists with package.json and tsconfigs
2. npm run build:shared compiles shared package
3. Both CJS and ESM outputs exist in dist/
4. Frontend can import from @epub-counter/shared
5. Backend can import from @epub-counter/shared
6. npm run dev starts both servers without import errors
7. TypeScript provides IntelliSense for shared types in both frontend and backend
</verification>

<success_criteria>
- [ ] Shared package directory structure created
- [ ] Dual CJS/ESM build configuration in place
- [ ] Shared types defined (EpubMetadata, TokenCountResult, etc.)
- [ ] npm workspaces configured with shared, web, server
- [ ] TypeScript path mapping configured for @epub-counter/shared
- [ ] Shared package builds successfully to dist/cjs and dist/esm
- [ ] Frontend can import and use shared types
- [ ] Backend can import and use shared types
- [ ] npm run build compiles shared package
- [ ] npm run build compiles both frontend (web) and backend (server) without errors
- [ ] postinstall hook builds shared package automatically
- [ ] Combined dev script runs both frontend and backend servers
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation-project-setup/04-04-SUMMARY.md`
</output>
