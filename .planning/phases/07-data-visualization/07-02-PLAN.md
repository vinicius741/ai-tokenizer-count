---
phase: 07-data-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/components/visualization/ScatterChart.tsx
  - web/src/components/visualization/ChartContainer.tsx
  - web/src/lib/chart-utils.ts
  - web/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees scatter plot showing word count vs token count density"
    - "Scatter plot shows trend line for average tokenization ratio"
    - "All tokenizers appear on same plot with different colored points"
    - "Points are solid circles with border stroke (not transparent)"
    - "No equation text overlay on trend line (visual line only)"
  artifacts:
    - path: "web/src/components/visualization/ScatterChart.tsx"
      provides: "Word vs token density scatter plot with trend lines per tokenizer"
      min_lines: 70
      exports: ["TokenDensityScatter"]
    - path: "web/src/lib/chart-utils.ts"
      provides: "Additional utilities for scatter plot (group by helper)"
      min_lines: 35
      exports: ["groupBy", "TOKENIZER_COLORS"]
  key_links:
    - from: "web/src/components/visualization/ScatterChart.tsx"
      to: "recharts ScatterChart with lineType='fitting'"
      via: "import { ScatterChart, Scatter, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend }"
      pattern: "from 'recharts'"
    - from: "web/src/components/visualization/ScatterChart.tsx"
      to: "web/src/lib/chart-utils.ts"
      via: "import { TOKENIZER_COLORS, groupBy }"
      pattern: "import.*TOKENIZER_COLORS"
---

<objective>
Implement scatter plot visualization showing word count vs token count density with linear regression trend lines per tokenizer.

**Purpose:** Users need to understand the relationship between word count and token count across their EPUB collection. Scatter plots reveal tokenization efficiency (words per token ratio) and help identify outliers. Trend lines show the average tokenization ratio for each tokenizer.

**Output:** Working scatter plot component with:
- X-axis: Word count, Y-axis: Token count
- All tokenizers on same plot with different colored solid circle points
- Linear regression trend line per tokenizer (Recharts lineType='fitting')
- No equation text overlay (clean visual line only)
- Custom tooltip showing word count, token count, ratio, and EPUB metadata
- Legend identifying tokenizer colors
- Responsive sizing
</objective>

<execution_context>
@/Users/vinicusmoreira/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vinicusmoreira/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-visualization/07-CONTEXT.md
@.planning/phases/07-data-visualization/07-RESEARCH.md
@.planning/phases/07-data-visualization/07-01-PLAN.md
@.planning/phases/06-file-upload-tokenizer-selection/06-04-SUMMARY.md
@packages/shared/src/types.ts
@web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Add utility functions to chart-utils.ts</name>
  <files>web/src/lib/chart-utils.ts</files>
  <action>
    Update web/src/lib/chart-utils.ts to add:

    1. groupBy<T>(array: T[], key: keyof T): Record<string, T[]> helper:
       - Use Array.reduce() to group items by key
       - Handle edge cases (undefined values, empty array)
       - Return object with keys as grouped values

    This is needed to group scatter points by tokenizer name for rendering separate Scatter series.

    Reference the Object.groupBy alternative pattern from research.
  </action>
  <verify>
    ```bash
      grep -q "export.*groupBy" web/src/lib/chart-utils.ts
    ```
  </verify>
  <done>
    chart-utils.ts exports groupBy utility function for grouping array items by key
  </done>
</task>

<task type="auto">
  <name>Create ScatterChart component</name>
  <files>web/src/components/visualization/ScatterChart.tsx</files>
  <action>
    Create web/src/components/visualization/ScatterChart.tsx with TokenDensityScatter component:

    Props:
    - data: EpubResult[] (from ResultsOutput.results)
    - tokenizers: string[] (list of tokenizer names to plot)

    Implementation:
    1. Use useMemo to transform data:
       - Filter out results with error property
       - Map each result to multiple scatter points (one per tokenizer)
       - Each point: { x: wordCount, y: tokenCount, z: tokenizerName, metadata: result }
    2. Use groupBy utility to group points by tokenizer name
    3. Render:
       - ResponsiveContainer wrapping ScatterChart (height={400})
       - XAxis with dataKey="x", label with "Word Count"
       - YAxis with dataKey="y", label with "Token Count"
       - Tooltip with content={<CustomTooltip />} and cursor={{ strokeDasharray: '3 3' }}
       - Legend to identify tokenizer colors
       - For each tokenizer group: Scatter component with
         * name={tokenizer}
         * data={points}
         * fill={TOKENIZER_COLORS[tokenizer]}
         * line={{ stroke: color, strokeWidth: 2 }}
         * lineType="fitting" (enables linear regression trend line)
         * shape="circle"
         * r={5} (point size)
         * fillOpacity={1} (solid, not transparent)
         * stroke="white" stroke-width={2} (border for visibility)

    CRITICAL: Use tokenCounts.find(t => t.name === tokenizerName)?.count for y-value.

    Import CustomTooltip from same directory.
  </action>
  <verify>
    ```bash
      grep -q "export.*TokenDensityScatter" web/src/components/visualization/ScatterChart.tsx
    ```
  </verify>
  <done>
    ScatterChart.tsx exports TokenDensityScatter component that renders multi-tokenizer scatter plot with trend lines
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete scatter plot implementation with:
    - groupBy utility function for data transformation
    - TokenDensityScatter component with multi-tokenizer support
    - Linear regression trend lines via lineType="fitting"
    - Solid circle points with white border for visibility
  </what-built>
  <how-to-verify>
    1. Ensure dev server is running: npm run dev
    2. Load or process EPUB results
    3. Navigate to completion screen and verify scatter plot appears
    4. Check that points for each tokenizer are different colors
    5. Verify each tokenizer has a trend line showing linear regression
    6. Confirm no equation text overlays (clean lines only)
    7. Hover over points - verify tooltip shows word count, token count, EPUB info
    8. Check legend identifies which color is which tokenizer
  </how-to-verify>
  <resume-signal>Type "approved" if scatter plot works correctly, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Integrate ScatterChart into App.tsx</name>
  <files>web/src/App.tsx</files>
  <action>
    Update web/src/App.tsx to render scatter plot alongside bar charts:

    1. Import TokenDensityScatter from components/visualization/ScatterChart
    2. In the processingResults section, after the bar charts section:
       - Add new "Token Density Analysis" heading
       - Render ChartContainer with title "Word Count vs Token Count"
       - Pass processingResults.results and processingResults.options.tokenizers to TokenDensityScatter

    Place this in the same results display section as the bar charts (after CompletionSummary).

    Use consistent spacing with the bar charts section.
  </action>
  <verify>
    ```bash
      grep -q "TokenDensityScatter" web/src/App.tsx
    ```
  </verify>
  <done>
    App.tsx renders scatter plot showing word vs token density for all tokenizers after the bar charts section
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. ScatterChart component transforms EpubResult[] to scatter data points
2. Each tokenizer gets its own Scatter series with unique color
3. Trend lines display via lineType="fitting" with correct color matching
4. Points are solid circles (fillOpacity=1) with white border stroke
5. No equation text appears on chart (clean trend lines only)
6. Legend identifies tokenizer colors
7. CustomTooltip shows word count, token count, EPUB metadata on hover
8. X-axis labeled "Word Count", Y-axis labeled "Token Count"
9. All tokenizers appear on same plot (not separate plots)
10. Chart is responsive and handles window resize
</verification>

<success_criteria>
1. User sees scatter plot with word count (x-axis) vs token count (y-axis)
2. Each tokenizer has different colored points (GPT-4: blue, Claude: orange, HF: green)
3. Each tokenizer has a trend line showing average tokenization ratio
4. Points are solid circles with visible borders (not transparent)
5. Hovering shows tooltip with counts, ratio, and EPUB metadata
6. Legend clearly identifies which color represents which tokenizer
7. No equation text overlays the trend lines
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-visualization/07-02-SUMMARY.md` with summary of implementation
</output>
