---
phase: 07-data-visualization
plan: 05
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - web/src/components/visualization/ComparisonBarChart.tsx
  - web/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees side-by-side bar chart with grouped bars per EPUB"
    - "Each EPUB has multiple bars (one per tokenizer) side by side"
    - "Bars use tokenizer-specific colors matching other visualizations"
    - "Hovering over bar shows tooltip with exact token count and percentage vs lowest"
    - "X-axis shows EPUB titles, Y-axis shows token counts"
    - "Chart is scrollable horizontally when many EPUBs"
  artifacts:
    - path: "web/src/components/visualization/ComparisonBarChart.tsx"
      provides: "Side-by-side grouped bar chart for tokenizer comparison"
      min_lines: 80
      exports: ["ComparisonBarChart"]
  key_links:
    - from: "web/src/components/visualization/ComparisonBarChart.tsx"
      to: "recharts BarChart with multiple Bar series"
      via: "import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend, CartesianGrid }"
      pattern: "from 'recharts'"
    - from: "web/src/components/visualization/ComparisonBarChart.tsx"
      to: "web/src/lib/chart-utils.ts"
      via: "import { TOKENIZER_COLORS, transformToComparisonData }"
      pattern: "import.*TOKENIZER_COLORS|import.*transformToComparisonData"
    - from: "web/src/App.tsx"
      to: "web/src/components/visualization/ComparisonBarChart.tsx"
      via: "Import and render with ResultsOutput data"
      pattern: "import.*ComparisonBarChart|<ComparisonBarChart"
---

<objective>
Implement side-by-side comparison bar chart showing token counts for each tokenizer grouped by EPUB.

**Purpose:** Users need to visually compare how different tokenizers behave on the same EPUB content side by side. While the heatmap shows percentages, the side-by-side bar chart shows absolute token counts, making it easy to see the magnitude of differences between tokenizers for each book.

**Output:** Working side-by-side bar chart component with:
- Grouped bars: Each EPUB has one bar per tokenizer (side by side)
- Tokenizer-specific colors matching other charts (GPT-4: blue, Claude: orange, HF: green)
- X-axis: EPUB titles (scrollable if many)
- Y-axis: Token counts
- Custom tooltip showing exact count and percentage vs lowest tokenizer
- Legend identifying tokenizer colors
- Responsive sizing with horizontal scroll for many EPUBs
- Only renders when 2+ tokenizers present (requires comparison)
</objective>

<execution_context>
@/Users/vinicusmoreira/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vinicusmoreira/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-visualization/07-CONTEXT.md
@.planning/phases/07-data-visualization/07-RESEARCH.md
@.planning/phases/07-data-visualization/07-01-PLAN.md
@.planning/phases/07-data-visualization/07-04-PLAN.md
@.planning/phases/06-file-upload-tokenizer-selection/06-01-SUMMARY.md
@packages/shared/src/types.ts
@web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Create ComparisonBarChart component</name>
  <files>web/src/components/visualization/ComparisonBarChart.tsx</files>
  <action>
    Create web/src/components/visualization/ComparisonBarChart.tsx with ComparisonBarChart component:

    Props:
    - data: EpubResult[]
    - tokenizers: string[]

    Implementation:
    1. Use useMemo to transform data for grouped bar chart:
       - Filter out results with error property
       - Limit to top 20 EPUBs by word count (to prevent overcrowding)
       - Sort by title alphabetically for consistent ordering
       - Create array: { epubTitle, wordCount, [tokenizerName]: tokenCount }
    2. Create custom tooltip component:
       - Show EPUB title
       - Show tokenizer name
       - Show exact token count
       - Calculate/show percentage vs lowest count for this EPUB
    3. Render:
       - Card with CardHeader containing CardTitle
       - ResponsiveContainer wrapping BarChart (height={400}, width="100%")
       - CartesianGrid with strokeDasharray="3 3"
       - XAxis with dataKey="epubTitle", tick={{ fontSize: 12 }}
       - YAxis label={{ value: 'Token Count', angle: -90, position: 'insideLeft' }}
       - Tooltip with content={<CustomTooltip />} and cursor={{ fill: 'rgba(0,0,0,0.1)' }}
       - Legend to identify tokenizer colors
       - For each tokenizer: Bar component with
         * dataKey={tokenizer}
         * fill={TOKENIZER_COLORS[tokenizer]}
         * name={tokenizer}
         * radius={[4, 4, 0, 0]} (rounded top corners)

    CRITICAL: Access token counts via tokenCounts.find(t => t.name === tokenizerName)?.count.

    Import Card, CardHeader, CardTitle from shadcn/ui.
  </action>
  <verify>
    ```bash
      grep -q "export.*ComparisonBarChart" web/src/components/visualization/ComparisonBarChart.tsx
    ```
  </verify>
  <done>
    ComparisonBarChart.tsx exports ComparisonBarChart component with grouped bars per EPUB
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete side-by-side comparison bar chart with:
    - Grouped bars showing token counts for each tokenizer per EPUB
    - Tokenizer-specific colors matching other visualizations
    - Custom tooltip with exact counts and percentage differences
    - Limited to top 20 EPUBs to prevent overcrowding
  </what-built>
  <how-to-verify>
    1. Ensure dev server is running
    2. Load or process EPUB results with multiple tokenizers
    3. Navigate to completion screen and verify side-by-side bar chart appears
    4. Check that each EPUB has multiple bars (one per tokenizer) grouped together
    5. Verify bars use correct tokenizer colors (matching other charts)
    6. Hover over bars - verify tooltip shows token count and percentage vs lowest
    7. Check that x-axis shows EPUB titles, y-axis shows token counts
    8. Verify chart only appears when 2+ tokenizers are present
    9. Test horizontal scrolling if many EPUBs
  </how-to-verify>
  <resume-signal>Type "approved" if bar chart works correctly, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Integrate ComparisonBarChart into App.tsx</name>
  <files>web/src/App.tsx</files>
  <action>
    Update web/src/App.tsx to render side-by-side comparison bar chart:

    1. Import ComparisonBarChart from components/visualization/ComparisonBarChart
    2. In the processingResults section, after ComparisonHeatmap:
       - Add conditional rendering: only show if tokenizers.length >= 2
       - Add "Side-by-Side Comparison" heading
       - Render ChartContainer with title "Token Count Comparison by EPUB"
       - Pass processingResults.results and processingResults.options.tokenizers to ComparisonBarChart
    3. Place in same comparison visualization section as heatmap (with consistent spacing)

    This appears alongside the heatmap, giving users two ways to compare tokenizers (heatmap for percentages, side-by-side bars for absolute values).
  </action>
  <verify>
    ```bash
      grep -q "ComparisonBarChart" web/src/App.tsx
    ```
  </verify>
  <done>
    App.tsx renders ComparisonBarChart when results have 2+ tokenizers, appearing after the heatmap
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. ComparisonBarChart component transforms EpubResult[] to grouped bar chart data
2. Chart limits to top 20 EPUBs by word count
3. Each EPUB has one bar per tokenizer (grouped side by side)
4. Bars use tokenizer-specific colors matching other charts
5. X-axis shows EPUB titles, Y-axis shows token counts
6. Hovering shows tooltip with exact count and percentage vs lowest
7. Chart has legend identifying tokenizer colors
8. Chart only renders when 2+ tokenizers are present
9. Chart is responsive and handles window resize
10. App.tsx renders chart in comparison section after heatmap
</verification>

<success_criteria>
1. User sees side-by-side bar chart with grouped bars per EPUB
2. Each EPUB has multiple bars (one per tokenizer) grouped together
3. Bars use tokenizer-specific colors (GPT-4: blue, Claude: orange, HF: green)
4. X-axis shows EPUB titles, Y-axis shows token counts
5. Hovering over bar shows tooltip with exact token count and percentage vs lowest
6. Legend clearly identifies which color represents which tokenizer
7. Chart only appears when results include 2+ tokenizers
8. User can visually compare absolute token counts between tokenizers for each EPUB
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-visualization/07-05-SUMMARY.md` with summary of implementation
</output>
