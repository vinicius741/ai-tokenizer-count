---
phase: 07-data-visualization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - web/package.json
  - web/src/components/visualization/ResultsTable.tsx
  - web/src/components/visualization/TokenRangeSlider.tsx
  - web/src/hooks/use-table-data.ts
  - web/src/lib/csv-export.ts
  - web/src/App.tsx
  - web/src/components/ui/slider.ts
autonomous: false

must_haves:
  truths:
    - "User sees results table with columns (Title, Author, Words, Tokens, File Path)"
    - "Results table is sortable by any column (ascending/descending)"
    - "Results table is filterable by title/author text search"
    - "Results table is filterable by token count range slider"
    - "Search filter is collapsible (shows only after clicking search icon button)"
    - "Table is sorted by primary tokenizer token count descending by default"
    - "Rows have comfortable spacing with generous height for easy scanning"
    - "User can export results table to CSV via download button"
  artifacts:
    - path: "web/src/components/visualization/ResultsTable.tsx"
      provides: "Sortable/filterable data table with TanStack Table"
      min_lines: 130
      exports: ["ResultsTable"]
    - path: "web/src/components/visualization/TokenRangeSlider.tsx"
      provides: "Dual-handle range slider for token count filtering"
      min_lines: 50
      exports: ["TokenRangeSlider"]
    - path: "web/src/hooks/use-table-data.ts"
      provides: "Custom hook for table data transformation and memoization"
      min_lines: 55
      exports: ["useTableData"]
    - path: "web/src/lib/csv-export.ts"
      provides: "CSV export utilities using react-papaparse"
      min_lines: 30
      exports: ["exportToCSV"]
    - path: "web/package.json"
      provides: "Added @tanstack/react-table, react-papaparse, and shadcn/ui Slider dependencies"
  key_links:
    - from: "web/src/components/visualization/ResultsTable.tsx"
      to: "@tanstack/react-table"
      via: "import { useReactTable, getCoreRowModel, getSortedRowModel, getFilteredRowModel }"
      pattern: "from '@tanstack/react-table'"
    - from: "web/src/components/visualization/ResultsTable.tsx"
      to: "web/src/components/visualization/TokenRangeSlider.tsx"
      via: "import { TokenRangeSlider }"
      pattern: "import.*TokenRangeSlider"
    - from: "web/src/components/visualization/TokenRangeSlider.tsx"
      to: "web/src/components/ui/slider"
      via: "import { Slider } from '@/components/ui/slider'"
      pattern: "from '@/components/ui/slider'"
    - from: "web/src/lib/csv-export.ts"
      to: "react-papaparse"
      via: "import { useCSVDownloader } from 'react-papaparse'"
      pattern: "from 'react-papaparse'"
    - from: "web/src/App.tsx"
      to: "web/src/components/visualization/ResultsTable.tsx"
      via: "Import and render with ResultsOutput data"
      pattern: "import.*ResultsTable|<ResultsTable"
---

<objective>
Implement sortable and filterable results data table with CSV export functionality.

**Purpose:** Users need a detailed tabular view of all EPUB results to scan data, sort by any column, filter by text search, and export for external analysis. The table complements visual charts with a precise data view.

**Output:** Working results table component with:
- Columns: Title, Author, Words, Tokens (per tokenizer), File Path
- Click-to-sort on any column (ascending/descending with indicators)
- Collapsible text search filter (title/author)
- Default sort by primary tokenizer token count descending
- Comfortable row spacing for readability
- CSV export button that downloads all filtered/sorted data
- Responsive table with horizontal scroll if needed
</objective>

<execution_context>
@/Users/vinicusmoreira/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vinicusmoreira/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-visualization/07-CONTEXT.md
@.planning/phases/07-data-visualization/07-RESEARCH.md
@.planning/phases/07-data-visualization/07-01-PLAN.md
@.planning/phases/06-file-upload-tokenizer-selection/06-01-SUMMARY.md
@packages/shared/src/types.ts
@web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Install TanStack Table and react-papaparse</name>
  <files>web/package.json</files>
  <action>
    Install table and CSV export dependencies:
    ```bash
    cd web && npm install @tanstack/react-table react-papaparse papaparse @types/papaparse
    ```

    These libraries provide:
    - @tanstack/react-table: Headless table logic for sorting/filtering
    - react-papaparse: CSV export with RFC 4180 compliance
    - papaparse: Peer dependency for react-papaparse
    - @types/papaparse: TypeScript types
  </action>
  <verify>
    ```bash
      grep -E "@tanstack/react-table|react-papaparse" web/package.json
    ```
  </verify>
  <done>
    web/package.json includes @tanstack/react-table, react-papaparse, papaparse, and @types/papaparse
  </done>
</task>

<task type="auto">
  <name>Create CSV export utilities</name>
  <files>web/src/lib/csv-export.ts</files>
  <action>
    Create web/src/lib/csv-export.ts with exportToCSV utility:

    1. Import useCSVDownloader from 'react-papaparse'
    2. Create exportToCSV function taking:
       - data: EpubResult[]
       - tokenizers: string[]
       - filename: string (optional, defaults to timestamp-based)
    3. Transform data to flat structure:
       - Map each result to object with: title, author, wordCount, and one column per tokenizer
       - Example: { title, author, wordCount, "gpt4 tokens", "claude tokens", ... }
    4. Return CSVDownloader component configured with:
       - filename parameter
       - data parameter
       - type={Type.Button}
       - Children: "Export to CSV" button text

    Handle token count access via tokenCounts.find(t => t.name === tokenizerName)?.count || 0

    CRITICAL: Use useMemo wrapper in component that calls this to avoid re-transforming on every render.
  </action>
  <verify>
    ```bash
      test -f web/src/lib/csv-export.ts && grep -q "exportToCSV" web/src/lib/csv-export.ts
    ```
  </verify>
  <done>
    csv-export.ts exports exportToCSV function that returns CSVDownloader component
  </done>
</task>

<task type="auto">
  <name>Create useTableData hook</name>
  <files>web/src/hooks/use-table-data.ts</files>
  <action>
    Create web/src/hooks/use-table-data.ts with useTableData custom hook:

    Props:
    - results: EpubResult[]
    - tokenizers: string[]
    - primaryTokenizer: string (for default sort)

    Implementation:
    1. Use useMemo to transform data:
       - Filter out results with error property
       - Add computed property for primary tokenizer token count (for default sort)
       - Return flattened array for table consumption
    2. Export both transformed data and helper functions

    Hook interface:
    ```typescript
    interface TableData {
      title: string;
      author: string;
      wordCount: number;
      [key: string]: string | number; // Token counts per tokenizer
    }

    export function useTableData(results: EpubResult[], tokenizers: string[], primaryTokenizer: string): {
      data: TableData[];
      columns: ColumnDef<TableData>[];
      minTokenCount: number;
      maxTokenCount: number;
    }
    ```

    This hook encapsulates data transformation and column definitions, keeping the component clean.

    CRITICAL: Add minTokenCount and maxTokenCount calculation for range slider bounds.
  </action>
  <verify>
    ```bash
      test -f web/src/hooks/use-table-data.ts && grep -q "export.*useTableData" web/src/hooks/use-table-data.ts
    ```
  </verify>
  <done>
    use-table-data.ts exports useTableData hook that returns transformed data, column definitions, and token count bounds
  </done>
</task>

<task type="auto">
  <name>Create TokenRangeSlider component</name>
  <files>web/src/components/visualization/TokenRangeSlider.tsx</files>
  <action>
    Create web/src/components/visualization/TokenRangeSlider.tsx with TokenRangeSlider component:

    Props:
    - min: number (minimum token count in data)
    - max: number (maximum token count in data)
    - value: [number, number] (current range [min, max])
    - onChange: (value: [number, number]) => void

    Implementation:
    1. Create dual-handle slider using shadcn/ui Slider component
    2. Configure Slider with:
       - min={0}, max={max}
       - step={1} (integer values)
       - value={value}
       - onValueChange={(vals) => onChange([vals[0], vals[1]])}
    3. Display current range labels below slider:
       - "Min: {value[0].toLocaleString()} tokens"
       - "Max: {value[1].toLocaleString()} tokens"
    4. Add "Reset" button to reset to full range [min, max]
    5. Use flex layout for labels (left: min, center: reset, right: max)

    CRITICAL: shadcn/ui Slider supports multiple handles via value array. Ensure Slider component is installed via npx shadcn@latest add slider.

    Import Button from shadcn/ui. Import RotateCcw icon from lucide-react for reset button.
  </action>
  <verify>
    ```bash
      test -f web/src/components/visualization/TokenRangeSlider.tsx && grep -q "export.*TokenRangeSlider" web/src/components/visualization/TokenRangeSlider.tsx
    ```
  </verify>
  <done>
    TokenRangeSlider.tsx exports TokenRangeSlider component with dual-handle slider for token count filtering
  </done>
</task>

<task type="auto">
  <name>Create ResultsTable component</name>
  <files>web/src/components/visualization/ResultsTable.tsx</files>
  <action>
    Create web/src/components/visualization/ResultsTable.tsx with ResultsTable component:

    Props:
    - data: EpubResult[]
    - tokenizers: string[]
    - primaryTokenizer: string (first tokenizer or user-specified)

    Implementation:
    1. Call useTableData hook to get data, columns, minTokenCount, maxTokenCount
    2. Create sorting state: useState<SortingState> with default [{ id: primaryTokenizer, desc: true }]
    3. Create global filter state: useState<string> for search
    4. Create showSearch state: useState<boolean> for collapsible search
    5. Create token range state: useState<[number, number]>([minTokenCount, maxTokenCount])
    6. Use useReactTable with:
       - data, columns
       - getCoreRowModel()
       - getSortedRowModel()
       - getFilteredRowModel()
       - state: { sorting, globalFilter }
       - onSortingChange, onGlobalFilterChange
       - Add filter function for token range (filters rows where primaryTokenizer count is outside range)
    7. Render:
       - Card with CardHeader containing CardTitle and actions row
       - Actions row: Search icon button (toggle), Export to CSV button (from csv-export.ts)
       - Collapsible Input for search (shows when showSearch is true)
       - TokenRangeSlider component (below search, shows current range filter)
       - Table element with:
         * Thead with sortable headers (click handlers, sort indicators)
         * Tbody with rows from table.getRowModel().rows
         * Generous padding (px-4 py-4) for comfortable spacing
       - Use flexRender from TanStack Table for cell rendering
       - Format numbers with toLocaleString()

    CRITICAL: For token range filtering, add a column filter to the primary tokenizer column using useReactTable's filter feature. Filter function: row => row.getValue(primaryTokenizer) >= tokenRange[0] && row.getValue(primaryTokenizer) <= tokenRange[1].

    Import TokenRangeSlider from components/visualization/TokenRangeSlider.
    Import Button, Input from shadcn/ui. Import Search, Download icons from lucide-react.
  </action>
  <verify>
    ```bash
      grep -q "export.*ResultsTable" web/src/components/visualization/ResultsTable.tsx
    ```
  </verify>
  <done>
    ResultsTable.tsx exports ResultsTable component with sorting, filtering (search + range slider), and CSV export functionality
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete results table implementation with:
    - TanStack Table integration for headless table logic
    - Sortable columns with visual indicators (arrows)
    - Collapsible search filter for title/author
    - TokenRangeSlider component for token count range filtering
    - CSV export using react-papaparse
    - useTableData hook for data transformation with min/max bounds
  </what-built>
  <how-to-verify>
    1. Ensure dev server is running
    2. Load or process EPUB results
    3. Navigate to completion screen and verify table appears
    4. Check default sort is by token count descending (largest first)
    5. Click column headers - verify sorting toggles ascending/descending with arrows
    6. Click search icon button - verify input field appears below
    7. Type in search - verify table filters by title/author
    8. Drag range slider handles - verify table filters to token count range
    9. Click Reset button on slider - verify range resets to full min/max
    10. Click Export to CSV - verify CSV file downloads with correct data
    11. Check table row spacing is comfortable for reading
  </how-to-verify>
  <resume-signal>Type "approved" if table works correctly, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Integrate ResultsTable into App.tsx</name>
  <files>web/src/App.tsx</files>
  <action>
    Update web/src/App.tsx to render results table:

    1. Import ResultsTable from components/visualization/ResultsTable
    2. In the processingResults section, after scatter plot:
       - Add new "Detailed Results" heading
       - Render ResultsTable with:
         * data={processingResults.results}
         * tokenizers={processingResults.options.tokenizers}
         * primaryTokenizer={processingResults.options.tokenizers[0] || 'gpt4'}
    3. Place in same results display section with other visualizations

    Use consistent spacing and Card wrapper pattern.
  </action>
  <verify>
    ```bash
      grep -q "ResultsTable" web/src/App.tsx
    ```
  </verify>
  <done>
    App.tsx renders ResultsTable with all visualization data after the scatter plot section
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. TanStack Table is installed and imported
2. react-papaparse is installed and used for CSV export
3. shadcn/ui Slider component is installed
4. useTableData hook transforms EpubResult[] to table data format with min/max bounds
5. TokenRangeSlider component renders dual-handle slider
6. ResultsTable component renders table with all columns
7. Column headers are clickable and show sort indicators
8. Search icon button toggles collapsible input field
9. Text search filters table by title and author
10. Range slider filters table by token count range
11. Reset button on slider resets range to full min/max
12. Default sort is by primary tokenizer token count descending
13. CSV export button downloads file with correct data
14. Table rows have comfortable spacing (py-4 or similar)
15. Numbers are formatted with locale strings (commas for thousands)
</verification>

<success_criteria>
1. User sees table with Title, Author, Words, Tokens, File Path columns
2. Clicking any column header sorts by that column (ascending/descending)
3. Search icon button reveals/hides text input filter
4. Typing in search filters table by title or author
5. Range slider appears below search input with dual handles
6. Dragging slider handles filters table to selected token count range
7. Reset button on slider resets range to show all data
8. Table is sorted by token count descending on first render
9. Rows have generous spacing for easy scanning
10. Export to CSV button downloads CSV file with all visible data
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-visualization/07-03-SUMMARY.md` with summary of implementation
</output>
