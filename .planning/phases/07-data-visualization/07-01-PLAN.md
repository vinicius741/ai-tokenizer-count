---
phase: 07-data-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/package.json
  - web/src/lib/chart-utils.ts
  - web/src/components/visualization/BarChart.tsx
  - web/src/components/visualization/CustomTooltip.tsx
  - web/src/components/visualization/ChartContainer.tsx
  - web/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees bar chart showing token counts per EPUB with color-coded bars by tokenizer"
    - "User can click toggle button to sort by token count (ascending/descending)"
    - "User can hover over bar to see tooltip with exact token count, word count, title, author"
    - "Chart displays separate bar chart for each tokenizer (not grouped/split bars)"
    - "Bars use tokenizer-specific colors (blue for GPT-4, orange for Claude, green for HF)"
  artifacts:
    - path: "web/src/components/visualization/BarChart.tsx"
      provides: "Per-tokenizer bar chart with sorting toggle"
      min_lines: 80
      exports: ["TokenizerBarChart"]
    - path: "web/src/components/visualization/CustomTooltip.tsx"
      provides: "Shared tooltip component for all charts"
      min_lines: 40
      exports: ["CustomTooltip"]
    - path: "web/src/components/visualization/ChartContainer.tsx"
      provides: "Card wrapper with ResponsiveContainer for responsive charts"
      min_lines: 30
      exports: ["ChartContainer"]
    - path: "web/src/lib/chart-utils.ts"
      provides: "Tokenizer color palette and formatters"
      min_lines: 25
      exports: ["TOKENIZER_COLORS", "getTokenizerColor", "formatNumber"]
  key_links:
    - from: "web/src/components/visualization/BarChart.tsx"
      to: "recharts library"
      via: "import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer }"
      pattern: "from 'recharts'"
    - from: "web/src/App.tsx"
      to: "web/src/components/visualization/BarChart.tsx"
      via: "Import and render after CompletionSummary when processingResults exists"
      pattern: "import.*TokenizerBarChart|<TokenizerBarChart"
---

<objective>
Implement per-tokenizer bar charts showing token counts per EPUB with sortable bars, color-coded by tokenizer, and rich tooltips on hover.

**Purpose:** Users need to visualize token counts across all EPUBs to quickly identify which books consume the most tokens for each tokenizer. Bar charts provide an immediate visual comparison that helps users understand the distribution of token usage across their EPUB collection.

**Output:** Working bar chart component with:
- Separate chart rendered per tokenizer (GPT-4, Claude, HF models selected)
- Vertical orientation with EPUB titles on x-axis, token counts on y-axis
- Color-coded bars (blue for GPT-4, orange for Claude, green for HF)
- Toggle button for ascending/descending sort by token count
- Custom tooltip showing title, author, word count, token count, and file path on hover
- Responsive sizing that adapts to container width
</objective>

<execution_context>
@/Users/vinicusmoreira/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vinicusmoreira/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-visualization/07-CONTEXT.md
@.planning/phases/07-data-visualization/07-RESEARCH.md
@.planning/phases/06-file-upload-tokenizer-selection/06-01-SUMMARY.md
@.planning/phases/06-file-upload-tokenizer-selection/06-04-SUMMARY.md
@packages/shared/src/types.ts
@web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Install Recharts and create chart utilities</name>
  <files>web/package.json, web/src/lib/chart-utils.ts</files>
  <action>
    1. Install Recharts library:
       ```bash
       cd web && npm install recharts
       ```

    2. Create web/src/lib/chart-utils.ts with:
       - TOKENIZER_COLORS constant mapping tokenizer names to HSL color values
       - getTokenizerColor(tokenizerName: string) helper function
       - formatNumber(num: number) for formatting large numbers with commas
       - Export all utilities

    Color palette (use HSL for consistency with shadcn/ui):
    - gpt4: hsl(221, 83%, 53%) - Blue
    - claude: hsl(25, 95%, 53%) - Orange
    - HF models: hsl(142, 71%, 45%) - Green
    - default: hsl(215, 25%, 27%) - Slate
  </action>
  <verify>
    ```bash
      grep -q "recharts" web/package.json && test -f web/src/lib/chart-utils.ts
    ```
  </verify>
  <done>
    Recharts is installed in web/package.json and chart-utils.ts exports TOKENIZER_COLORS, getTokenizerColor, and formatNumber
  </done>
</task>

<task type="auto">
  <name>Create shared tooltip and container components</name>
  <files>web/src/components/visualization/CustomTooltip.tsx, web/src/components/visualization/ChartContainer.tsx</files>
  <action>
    Create visualization directory structure and components:

    1. Create web/src/components/visualization/CustomTooltip.tsx:
       - Accepts active, payload props from Recharts Tooltip
       - Returns null if not active or no payload
       - Renders shadcn/ui Card with metadata display
       - Shows: title (bold), author (muted), tokens (bold with formatting), words, file path
       - Use proper TypeScript types for payload

    2. Create web/src/components/visualization/ChartContainer.tsx:
       - Accepts title, children props
       - Wraps content in shadcn/ui Card with CardHeader, CardTitle, CardContent
       - Wraps children in Recharts ResponsiveContainer with width="100%" and height={300}
       - Provides consistent layout for all charts

    Reference research pattern for tooltip structure. Use Card from @/components/ui/card.
  </action>
  <verify>
    ```bash
      test -f web/src/components/visualization/CustomTooltip.tsx && test -f web/src/components/visualization/ChartContainer.tsx
    ```
  </verify>
  <done>
    CustomTooltip.tsx and ChartContainer.tsx exist and export components with proper TypeScript types
  </done>
</task>

<task type="auto">
  <name>Create BarChart component with sorting</name>
  <files>web/src/components/visualization/BarChart.tsx</files>
  <action>
    Create web/src/components/visualization/BarChart.tsx with TokenizerBarChart component:

    Props:
    - data: EpubResult[] (from ResultsOutput.results)
    - tokenizerName: string (e.g., "gpt4", "claude", "hf:bert-base-uncased")

    Implementation:
    1. Use useState for sortOrder: 'asc' | 'desc' (default 'desc')
    2. Use useMemo to transform data:
       - Filter out results with error property
       - Map to { name: title, value: tokenCount, metadata: fullResult }
       - Sort by value based on sortOrder
    3. Get tokenizer color using getTokenizerColor utility
    4. Render:
       - Button to toggle sort with arrow indicator
       - ResponsiveContainer wrapping BarChart
       - XAxis with dataKey="name", angle={-45}, textAnchor="end", height={80}, interval={0}
       - YAxis
       - Tooltip with content={<CustomTooltip />}
       - Bar with dataKey="value", fill={color}, radius={[8, 8, 0, 0]}

    Import types from @epub-counter/shared. Use CustomTooltip from same directory.

    CRITICAL: Access token count via tokenCounts.find(t => t.name === tokenizerName)?.count || 0
  </action>
  <verify>
    ```bash
      grep -q "export.*TokenizerBarChart" web/src/components/visualization/BarChart.tsx
    ```
  </verify>
  <done>
    BarChart.tsx exports TokenizerBarChart component that transforms EpubResult[] to chart data and renders sortable bar chart
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete bar chart implementation with:
    - Chart utilities (color palette, formatters)
    - CustomTooltip component for rich hover information
    - ChartContainer wrapper for consistent layout
    - TokenizerBarChart component with sorting toggle
  </what-built>
  <how-to-verify>
    1. Start the dev server: npm run dev (in root) or cd web && npm run dev
    2. Upload a results.json file or process EPUBs to get results
    3. Verify on the completion screen you see bar charts for each tokenizer used
    4. Check that bars are color-coded (blue for GPT-4, orange for Claude)
    5. Click the sort toggle button - verify bars re-sort in opposite order
    6. Hover over any bar - verify tooltip shows title, author, words, tokens, file path
    7. Check browser console for any errors
  </how-to-verify>
  <resume-signal>Type "approved" if bar charts work correctly, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Integrate BarChart into App.tsx</name>
  <files>web/src/App.tsx</files>
  <action>
    Update web/src/App.tsx to render bar charts after CompletionSummary:

    1. Import TokenizerBarChart from components/visualization/BarChart
    2. After CompletionSummary in the processingResults section, add new section:
       - Heading "Token Count Analysis"
       - Map through processingResults.options.tokenizers
       - For each tokenizer, render ChartContainer with title showing tokenizer name
       - Pass processingResults.results and tokenizer name to TokenizerBarChart

    Use the tokenizer display name from TokenizerInfo for titles (e.g., "GPT-4" not "gpt4").

    Reference the CompletionSummary section for layout consistency.
  </action>
  <verify>
    ```bash
      grep -q "TokenizerBarChart" web/src/App.tsx
    ```
  </verify>
  <done>
    App.tsx renders a bar chart for each tokenizer in results.options.tokenizers after the CompletionSummary
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. Recharts is installed and imported in BarChart.tsx
2. BarChart component transforms EpubResult[] to chart data format
3. Each tokenizer gets its own bar chart with correct color
4. Sort toggle button switches between ascending/descending order
5. CustomTooltip displays title, author, words, tokens, file path on hover
6. X-axis labels are angled to prevent overlap
7. Charts are responsive and resize with window
8. Failed EPUBs (with error property) are filtered from display
9. App.tsx renders charts after CompletionSummary when results exist
</verification>

<success_criteria>
1. User sees separate bar chart for each tokenizer showing token counts per EPUB
2. Bars are color-coded by tokenizer (GPT-4: blue, Claude: orange, HF: green)
3. Sort toggle button changes bar order (ascending/descending) with visual feedback
4. Hovering over any bar shows tooltip with title, author, word count, token count, file path
5. Charts render in the completion section after processing finishes
6. No console errors when viewing charts with various data sizes
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-visualization/07-01-SUMMARY.md` with summary of implementation
</output>
