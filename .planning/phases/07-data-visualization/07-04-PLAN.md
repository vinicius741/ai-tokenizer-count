---
phase: 07-data-visualization
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-03"]
files_modified:
  - web/src/components/visualization/ComparisonHeatmap.tsx
  - web/src/lib/chart-utils.ts
  - web/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees heatmap grid showing EPUBs as rows, tokenizers as columns"
    - "Each cell shows percentage difference relative to lowest token count"
    - "Heatmap uses sequential green color scale (light to dark = higher percentage)"
    - "Hovering over cell shows tooltip with exact token counts and percentage"
    - "User can export comparison table to CSV via download button"
    - "Percentages are calculated relative to lowest token count across tokenizers"
  artifacts:
    - path: "web/src/components/visualization/ComparisonHeatmap.tsx"
      provides: "Multi-tokenizer comparison heatmap with percentage differences"
      min_lines: 100
      exports: ["ComparisonHeatmap"]
    - path: "web/src/lib/chart-utils.ts"
      provides: "Heatmap color scale utility functions"
      min_lines: 45
      exports: ["getHeatmapColor", "transformToComparisonData"]
  key_links:
    - from: "web/src/components/visualization/ComparisonHeatmap.tsx"
      to: "web/src/lib/chart-utils.ts"
      via: "import { transformToComparisonData, getHeatmapColor }"
      pattern: "import.*transformToComparisonData"
    - from: "web/src/components/visualization/ComparisonHeatmap.tsx"
      to: "web/src/lib/csv-export.ts"
      via: "Reusing exportToCSV for comparison data export"
      pattern: "import.*exportToCSV"
    - from: "web/src/App.tsx"
      to: "web/src/components/visualization/ComparisonHeatmap.tsx"
      via: "Import and render with ResultsOutput data"
      pattern: "import.*ComparisonHeatmap|<ComparisonHeatmap"
---

<objective>
Implement multi-tokenizer comparison heatmap showing percentage differences relative to the lowest token count for each EPUB.

**Purpose:** Users need to compare how different tokenizers behave on the same EPUB content. The heatmap view highlights which tokenizers are most efficient (fewer tokens) vs least efficient (more tokens) for each book, helping users choose the right tokenizer for their use case.

**Output:** Working comparison heatmap component with:
- Grid layout: EPUBs as rows, tokenizers as columns
- Cells show percentage relative to lowest token count (100% = lowest, higher = more tokens)
- Sequential green color scale (light green = 100-105%, dark green = 140%+)
- Tooltip on hover showing exact token counts and percentage
- CSV export button for comparison data
- Responsive table with horizontal scroll if many tokenizers
</objective>

<execution_context>
@/Users/vinicusmoreira/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vinicusmoreira/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-visualization/07-CONTEXT.md
@.planning/phases/07-data-visualization/07-RESEARCH.md
@.planning/phases/07-data-visualization/07-01-PLAN.md
@.planning/phases/07-data-visualization/07-03-PLAN.md
@.planning/phases/06-file-upload-tokenizer-selection/06-01-SUMMARY.md
@packages/shared/src/types.ts
@web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Add comparison utilities to chart-utils.ts</name>
  <files>web/src/lib/chart-utils.ts</files>
  <action>
    Update web/src/lib/chart-utils.ts to add comparison utilities:

    1. Add transformToComparisonData function:
       - Input: results: EpubResult[], tokenizerNames: string[]
       - Filter out results with error property
       - For each result, extract token counts per tokenizer
       - Find lowest count across all tokenizers
       - Calculate percentage: (count / lowestCount) * 100
       - Return array: { epubTitle, tokenizers (counts), lowestCount, percentages }

    2. Add getHeatmapColor function:
       - Input: percentage: number
       - Return Tailwind color class based on percentage bins:
         * < 105%: bg-green-100 (lightest)
         * 105-115%: bg-green-200
         * 115-125%: bg-green-300
         * 125-140%: bg-green-400
         * 140%+: bg-green-500 (darkest)
       - Use hsl() color values for shadcn/ui compatibility if needed

    3. Export both functions

    CRITICAL: Handle edge case where lowestCount is 0 (avoid division by zero)
  </action>
  <verify>
    ```bash
      grep -E "transformToComparisonData|getHeatmapColor" web/src/lib/chart-utils.ts
    ```
  </verify>
  <done>
    chart-utils.ts exports transformToComparisonData and getHeatmapColor utility functions
  </done>
</task>

<task type="auto">
  <name>Create ComparisonHeatmap component</name>
  <files>web/src/components/visualization/ComparisonHeatmap.tsx</files>
  <action>
    Create web/src/components/visualization/ComparisonHeatmap.tsx with ComparisonHeatmap component:

    Props:
    - data: EpubResult[]
    - tokenizers: string[]

    Implementation:
    1. Use useMemo with transformToComparisonData to get comparison data
    2. Create custom tooltip component for heatmap cells:
       - Show EPUB title
       - Show tokenizer name
       - Show exact token count
       - Show percentage vs lowest count
    3. Render:
       - Card with CardHeader containing CardTitle and Export button
       - Export button uses exportToCSV from csv-export.ts (transform data for CSV format)
       - Overflow-x-auto div for horizontal scroll
       - Table element with:
         * Thead with "EPUB" header cell + tokenizer header cells
         * Tbody with rows per EPUB
         * Each row: epubTitle cell + tokenizer percentage cells
       - Percentage cells:
         * Apply getHeatmapColor(percentage) class
         * Show percentage.toFixed(1) + '%'
         * Title attribute with full tooltip info
         * Rounded corners, padding, centered text
       - Use cn() from lib/utils for conditional class merging

    For CSV export: Transform comparison data to flat structure with epubTitle, tokenizer columns showing percentages.

    Import Card, CardHeader, CardTitle from shadcn/ui. Import Download icon from lucide-react.
  </action>
  <verify>
    ```bash
      grep -q "export.*ComparisonHeatmap" web/src/components/visualization/ComparisonHeatmap.tsx
    ```
  </verify>
  <done>
    ComparisonHeatmap.tsx exports ComparisonHeatmap component with heatmap grid and CSV export
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete comparison heatmap implementation with:
    - transformToComparisonData utility for percentage calculation
    - getHeatmapColor utility for sequential green color scale
    - ComparisonHeatmap component with grid layout
    - CSV export for comparison data
    - Tooltips showing exact counts and percentages
  </what-built>
  <how-to-verify>
    1. Ensure dev server is running
    2. Load or process EPUB results with multiple tokenizers
    3. Navigate to completion screen and verify comparison heatmap appears
    4. Check that rows are EPUBs and columns are tokenizers
    5. Verify cells show percentages (e.g., "100.0%", "112.5%")
    6. Check color scale: lower percentages lighter green, higher darker green
    7. Hover over cells - verify tooltip shows exact token counts and percentage
    8. Click Export to CSV - verify file downloads with comparison data
    9. Test with different tokenizer combinations (2+, 3+ tokenizers)
  </how-to-verify>
  <resume-signal>Type "approved" if heatmap works correctly, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Integrate ComparisonHeatmap into App.tsx</name>
  <files>web/src/App.tsx</files>
  <action>
    Update web/src/App.tsx to render comparison heatmap:

    1. Import ComparisonHeatmap from components/visualization/ComparisonHeatmap
    2. In the processingResults section, add conditional rendering:
       - Only show heatmap if processingResults.options.tokenizers.length >= 2
       - Comparison requires at least 2 tokenizers to be meaningful
    3. Place after results table in visualization section:
       - Add "Tokenizer Comparison" heading
       - Render ComparisonHeatmap with:
         * data={processingResults.results}
         * tokenizers={processingResults.options.tokenizers}

    Use consistent spacing and Card wrapper pattern with other visualizations.
  </action>
  <verify>
    ```bash
      grep -q "ComparisonHeatmap" web/src/App.tsx
    ```
  </verify>
  <done>
    App.tsx renders ComparisonHeatmap when results have 2+ tokenizers, appearing after the results table
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. transformToComparisonData transforms EpubResult[] to comparison data structure
2. getHeatmapColor returns correct Tailwind classes based on percentage
3. ComparisonHeatmap component renders grid with EPUBs as rows, tokenizers as columns
4. Cells show percentage values formatted to 1 decimal place
5. Color scale uses sequential green (light to dark = 100% to 140%+)
6. Hovering over cells shows tooltip with exact counts and percentage
7. CSV export button downloads comparison data
8. Heatmap only renders when 2+ tokenizers are present
9. Table has horizontal scroll for many tokenizers
10. Percentages are calculated correctly relative to lowest count per EPUB
</verification>

<success_criteria>
1. User sees heatmap grid with EPUB titles as rows, tokenizer names as columns
2. Each cell displays percentage relative to lowest token count (e.g., "105.2%")
3. Cells use sequential green color scale (lighter = closer to lowest, darker = higher)
4. Hovering over cell shows tooltip with exact token count and percentage
5. Export to CSV button downloads comparison table
6. Heatmap only appears when results include 2+ tokenizers
7. User can visually identify which tokenizer is most efficient for each EPUB
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-visualization/07-04-SUMMARY.md` with summary of implementation
</output>
