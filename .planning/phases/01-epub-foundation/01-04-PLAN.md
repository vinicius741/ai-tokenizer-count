---
phase: 01-epub-foundation
plan: 04
type: execute
wave: 3
depends_on: [01-03]
files_modified:
  - src/errors/handler.ts
  - src/output/markdown.ts
  - src/output/json.ts
  - src/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "Tool continues processing remaining EPUBs when one file fails"
    - "Errors are logged to stderr console during processing"
    - "Errors are logged to errors.log file in output folder"
    - "Error summary displays after processing (total, successful, failed)"
    - "results.md file is created in output folder (default ./results/ or custom via --output)"
    - "results.json file is created in output folder with word_count per EPUB (OUT-04)"
    - "Output folder (default ./results/ or custom via --output) is created if it doesn't exist"
    - "User can specify custom output folder via --output flag (CLI-05)"
  artifacts:
    - path: "src/errors/handler.ts"
      provides: "Error handling and continue-on-error logic"
      exports: ["processEpubsWithErrors", "ProcessingResult", "logError"]
    - path: "src/output/markdown.ts"
      provides: "Markdown report generation"
      exports: ["generateResultsMarkdown", "writeResultsFile"]
    - path: "src/output/json.ts"
      provides: "JSON output generation with word_count (OUT-04)"
      exports: ["generateJsonOutput", "writeJsonFile", "EpubJsonResult"]
    - path: "src/cli/index.ts"
      provides: "Updated CLI with error handling and output folder support"
      contains: "processEpubsWithErrors integration, error summary display, options.output passed to output functions"
  key_links:
    - from: "src/errors/handler.ts"
      to: "src/cli/index.ts"
      via: "processEpubsWithErrors function replaces direct processing loop"
      pattern: "import.*processEpubsWithErrors"
    - from: "src/errors/handler.ts"
      to: "errors.log"
      via: "File system write to output folder (./results/ or custom)"
      pattern: "fs\\.writeFile.*errors\\.log"
    - from: "src/output/markdown.ts"
      to: "results.md"
      via: "File system write to output folder (./results/ or custom)"
      pattern: "fs\\.writeFile.*results\\.md"
    - from: "src/output/json.ts"
      to: "results.json"
      via: "File system write to output folder (./results/ or custom)"
      pattern: "fs\\.writeFile.*results\\.json"
    - from: "src/cli/index.ts"
      to: "src/output/markdown.ts"
      via: "writeResultsFile call after processing, passed options.output as outputDir"
      pattern: "writeResultsFile\\(result.*outputDir.*options\\.output"
    - from: "src/cli/index.ts"
      to: "src/output/json.ts"
      via: "writeJsonFile call after processing, passed options.output as outputDir"
      pattern: "writeJsonFile\\(result.*outputDir.*options\\.output"
    - from: "src/cli/index.ts"
      to: "--output flag"
      via: "Commander option configured in Plan 01-03"
      pattern: "option.*--output"
---

<objective>
Implement error handling with continue-on-error behavior, dual error logging (console + file), markdown summary generation, JSON output with word_count per EPUB (OUT-04), and support for custom output folder via --output flag (CLI-05).

Purpose: Ensure the tool is robust against malformed EPUB files — when one file fails, processing continues for remaining files. Errors are logged both visibly (stderr) and persistently (errors.log). A markdown summary file and JSON file with word_count preserve results for later reference, satisfying OUT-04 requirement. Custom output folder support via --output flag satisfies CLI-05 requirement.

Output: CLI that handles errors gracefully, logs comprehensively, generates persistent results files (markdown + JSON with word_count), and supports custom output folder paths.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-epub-foundation/01-CONTEXT.md
@.planning/phases/01-epub-foundation/01-RESEARCH.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-epub-foundation/01-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement error handling and continue-on-error logic</name>
  <files>src/errors/handler.ts</files>
  <action>
Create src/errors/handler.ts with:

1. Export interface ProcessingResult:
   - successful: EpubResult[] (from table.ts)
   - failed: Array<{ file: string; error: string; suggestion?: string }>
   - total: number

2. Export interface ErrorLogEntry:
   - file: string
   - error: string
   - timestamp: string (ISO 8601)
   - suggestion?: string

3. Export async function logError(entry: ErrorLogEntry, outputDir: string): Promise<void>
   - Ensure outputDir exists using fs.mkdir(outputDir, { recursive: true })
   - Append to errors.log file (create if not exists)
   - Format: "[timestamp] ${entry.file}: ${entry.error}${entry.suggestion ? ' Suggestion: ' + entry.suggestion : ''}\n"
   - Use outputDir parameter (can be custom path from --output flag)

4. Export async function processEpubsWithErrors(filePaths: string[], verbose: boolean = false, outputDir: string = './results'): Promise<ProcessingResult>
   - Initialize empty successful and failed arrays
   - For each filePath in filePaths:
     - try:
       - Parse: parseEpubFile(filePath)
       - Extract metadata: extractMetadata(result.info)
       - Extract text: extractText(result.sections)
       - Count words: countWords(text)
       - Add to successful array
     - catch (error):
       - Extract error message: error.message || 'Unknown error'
       - Generate suggestion if possible (e.g., "File may be corrupted or not a valid EPUB")
       - Create ErrorLogEntry with file, error, timestamp, suggestion
       - Log to stderr: console.error(`Error: ${entry.file} - ${entry.error}`)
       - Call logError(entry, outputDir) — pass outputDir for custom output folder support
       - Add to failed array
   - Return { successful, failed, total: filePaths.length }

Use Continue-on-Error Pattern from RESEARCH.md as reference.

Implement helpful error suggestions:
- "File may be corrupted or not a valid EPUB" for general parse errors
- "Check file permissions" for EACCES errors
- "File not found" for ENOENT errors

Note: Default outputDir is './results' per CFG-02 requirement, but can be overridden via --output flag.
  </action>
  <verify>Test with malformed EPUB file — should log error to stderr and errors.log, continue processing remaining files</verify>
  <done>processEpubsWithErrors() processes all files, continues on error, logs to stderr and errors.log, returns success/failed arrays, accepts custom outputDir</done>
</task>

<task type="auto">
  <name>Task 2: Implement JSON output with word_count (OUT-04)</name>
  <files>src/output/json.ts</files>
  <action>
Create src/output/json.ts with:

1. Export interface EpubJsonResult:
   - filename: string
   - file_path: string (absolute path)
   - title: string
   - author: string
   - word_count: number (required by OUT-04)
   - language?: string
   - publisher?: string

2. Export interface JsonOutputOptions:
   - outputDir: string (default './results' per CFG-02, but accepts custom path for CLI-05)
   - filename: string (default 'results.json')

3. Export function generateJsonOutput(result: ProcessingResult, timestamp: string): object
   - Return object with structure:
     {
       generated_at: timestamp,
       summary: {
         total: result.total,
         successful: result.successful.length,
         failed: result.failed.length
       },
       epubs: result.successful.map(epub => ({
         filename: epub.filename,
         file_path: epub.file_path || epub.filename,
         title: epub.title,
         author: epub.author,
         word_count: epub.wordCount,  // OUT-04 requirement
         language: epub.language,
         publisher: epub.publisher
       })),
       failed: result.failed.map(f => ({
         file: f.file,
         error: f.error,
         suggestion: f.suggestion
       }))
     }

4. Export async function writeJsonFile(result: ProcessingResult, options?: JsonOutputOptions): Promise<string>
   - Default options: { outputDir: './results', filename: 'results.json' }
   - Accept custom outputDir for --output flag support (CLI-05)
   - Ensure outputDir exists using fs.mkdir(outputDir, { recursive: true })
   - Generate JSON content: generateJsonOutput(result, new Date().toISOString())
   - Write to file: fs.writeFile(path.join(outputDir, filename), JSON.stringify(content, null, 2))
   - Return absolute path to written file

Note: Default outputDir is './results' per CFG-02 requirement, but accepts custom path for CLI-05.
  </action>
  <verify>Run CLI with sample EPUBs — should create results.json with word_count field for each EPUB in output folder (default ./results/ or custom via --output)</verify>
  <done>writeJsonFile() creates results.json with summary, epubs array (each with word_count), and failed array; word_count field present per OUT-04; accepts custom outputDir per CLI-05</done>
</task>

<task type="auto">
  <name>Task 3: Implement markdown results generation</name>
  <files>src/output/markdown.ts</files>
  <action>
Create src/output/markdown.ts with:

1. Export interface MarkdownOptions:
   - outputDir: string (default './results' per CFG-02, but accepts custom path for CLI-05)
   - filename: string (default 'results.md')

2. Export function generateResultsMarkdown(result: ProcessingResult, timestamp: string): string
   - Generate markdown with:
     - Header: "# EPUB Processing Results"
     - Timestamp: "Generated: {timestamp}"
     - Summary section: "## Summary\n- Total: {total}\n- Successful: {successful.length}\n- Failed: {failed.length}"
     - Successful section (if any): "## Successful EPUBs\n\n| Filename | Words | Title | Author |\n|----------|-------|-------|--------|\n{table rows}"
     - Failed section (if any): "## Failed EPUBs\n\n{list of failures with error messages}"
   - Return formatted markdown string

3. Export async function writeResultsFile(result: ProcessingResult, options?: MarkdownOptions): Promise<string>
   - Default options: { outputDir: './results', filename: 'results.md' }
   - Accept custom outputDir for --output flag support (CLI-05)
   - Ensure outputDir exists using fs.mkdir(outputDir, { recursive: true })
   - Generate markdown content: generateResultsMarkdown(result, new Date().toISOString())
   - Write to file: fs.writeFile(path.join(outputDir, filename), content)
   - Return absolute path to written file

Format tables with standard GitHub Flavored Markdown table syntax.

Note: Default outputDir is './results' per CFG-02 requirement, but accepts custom path for CLI-05.
  </action>
  <verify>Run CLI with sample EPUBs — should create results.md with formatted summary, successful table, and failed list in output folder (default ./results/ or custom via --output)</verify>
  <done>writeResultsFile() creates results.md with summary statistics, successful EPUBs table, and failed EPUBs list with error details; accepts custom outputDir per CLI-05</done>
</task>

<task type="auto">
  <name>Task 4: Update CLI to use error handling, generate results files, and support custom output folder</name>
  <files>src/cli/index.ts</files>
  <action>
Update src/cli/index.ts:

1. Import processEpubsWithErrors from '../errors/handler.js'
2. Import writeResultsFile from '../output/markdown.js'
3. Import writeJsonFile from '../output/json.js'
4. Import path from 'path'

2. Modify processEpubs function to accept outputDir parameter:
   - Replace direct processing loop with: const result = await processEpubsWithErrors(allFiles, options.verbose, options.output || './results')
   - Call displayResults(result.successful) to show successful EPUBs table
   - Generate and write markdown results file: const mdPath = await writeResultsFile(result, { outputDir: options.output || './results' })
   - Generate and write JSON results file: const jsonPath = await writeJsonFile(result, { outputDir: options.output || './results' })
   - Display results file paths: console.log(`\nResults saved to:\n- ${mdPath}\n- ${jsonPath}`)
   - Display error summary:
     - console.log(`\nSummary:`)
     - console.log(`- Total EPUBs: ${result.total}`)
     - console.log(`- Successful: ${result.successful.length}`)
     - console.log(`- Failed: ${result.failed.length}`)
   - If verbose and failed.length > 0, list failed files

3. Handle "no EPUBs found" case:
   - If allFiles.length === 0, display message and exit gracefully
   - Don't create results files if no files were found

4. Ensure output directory is created before any file writes (handled by writeResultsFile/writeJsonFile internally)

Note: Use options.output if provided, otherwise default to './results/' per CFG-02 requirement. This wires the --output flag from Plan 01-03 through to the output functions, satisfying CLI-05.
  </action>
  <verify>Run CLI with mix of valid and invalid EPUBs — should process all files, display error summary, create results.md and results.json in output folder (default ./results/ or custom via --output flag)</verify>
  <done>CLI uses processEpubsWithErrors for robustness, displays error summary after processing, generates results.md and results.json files, handles empty EPUB list gracefully, passes options.output to output functions for custom folder support (CLI-05)</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` compiles without errors
2. Running CLI with invalid EPUB continues processing
3. errors.log is created in output folder (./results/ or custom via --output) with error details
4. results.md is created in output folder (./results/ or custom via --output) with summary and tables
5. results.json is created in output folder (./results/ or custom via --output) with word_count field per EPUB (OUT-04)
6. Error summary displays in console after processing
7. --output flag works to specify custom output folder (CLI-05)
</verification>

<success_criteria>
1. Malformed EPUB files don't crash the process
2. Errors appear in both stderr console and errors.log file
3. results.md contains summary statistics, successful table, and failed list
4. results.json contains summary, epubs array with word_count per EPUB (OUT-04), and failed array
5. Error summary shows total/successful/failed counts
6. Output folder is created automatically if missing (default ./results/ or custom via --output)
7. --output flag allows users to specify custom output folder path (CLI-05)
8. Default output folder is ./results/ when --output not provided (CFG-02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-epub-foundation/01-04-SUMMARY.md`
</output>
