---
phase: 01-epub-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/epub/parser.ts
  - src/epub/text.ts
  - src/epub/metadata.ts
autonomous: true

must_haves:
  truths:
    - "Tool can parse EPUB 2.0.1 and 3.0 format files"
    - "Tool extracts title from EPUB metadata"
    - "Tool extracts author/creator from EPUB metadata"
    - "Tool extracts language from EPUB metadata (if available)"
    - "Tool extracts publisher from EPUB metadata (if available)"
    - "Tool extracts readable text content from EPUB sections"
    - "Tool counts words accurately from extracted text"
    - "HTML tags are stripped before word counting"
  artifacts:
    - path: "src/epub/parser.ts"
      provides: "EPUB parsing wrapper"
      exports: ["parseEpubFile", "EpubParseResult"]
    - path: "src/epub/metadata.ts"
      provides: "Metadata extraction functions"
      exports: ["extractMetadata", "EpubMetadata"]
    - path: "src/epub/text.ts"
      provides: "Text extraction and word counting"
      exports: ["extractText", "countWords"]
  key_links:
    - from: "src/epub/parser.ts"
      to: "@gxl/epub-parser"
      via: "import parseEpub from npm package"
      pattern: "import.*parseEpub.*from.*@gxl/epub-parser"
    - from: "src/epub/text.ts"
      to: "word counting regex"
      via: "Regex split on whitespace with CJK support"
      pattern: "\\.split\\(/\\\\s\\+/\\)"
    - from: "src/epub/text.ts"
      to: "HTML tag stripping"
      via: "Regex or toMarkdown() method"
      pattern: "toMarkdown\\(\\)|replace\\(/<\\[^>\\]>/"
---

<objective>
Implement EPUB parsing, metadata extraction, and word counting functionality using @gxl/epub-parser library.

Purpose: Enable the tool to read EPUB files, extract their metadata (title, author, language, publisher), extract readable text content from all sections, and count words accurately.

Output: Working EPUB parser that returns metadata and word counts for any valid EPUB 2.0.1 or 3.0 file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-epub-foundation/01-CONTEXT.md
@.planning/phases/01-epub-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement EPUB parsing wrapper</name>
  <files>src/epub/parser.ts</files>
  <action>
Create src/epub/parser.ts with:

1. Import parseEpub from '@gxl/epub-parser'

2. Export interface EpubParseResult:
   - sections: Array from epubObj.sections
   - info: Metadata object from epubObj.info

3. Export async function parseEpubFile(filePath: string): Promise<EpubParseResult>
   - Call parseEpub(filePath, { type: 'path' })
   - Return object with sections and info
   - Wrap in try/catch to re-throw with context (include filePath in error message)

This is a thin wrapper around @gxl/epub-parser to isolate the library API.

Use Pattern 1 from RESEARCH.md as reference.
  </action>
  <verify>Run TypeScript compilation — should have no type errors related to epub-parser imports</verify>
  <done>parseEpubFile() successfully parses EPUB files and returns sections and info, throws descriptive errors on parse failures</done>
</task>

<task type="auto">
  <name>Task 2: Implement metadata extraction</name>
  <files>src/epub/metadata.ts</files>
  <action>
Create src/epub/metadata.ts with:

1. Export interface EpubMetadata:
   - title: string
   - author: string
   - language?: string
   - publisher?: string

2. Export function extractMetadata(epubInfo: any): EpubMetadata
   - Extract title: epubInfo.info?.title || 'Unknown Title'
   - Extract author: epubInfo.info?.creator || 'Unknown Author'
   - Extract language: epubInfo.info?.language (undefined if missing)
   - Extract publisher: epubInfo.info?.publisher (undefined if missing)

3. Handle missing or undefined epubInfo gracefully — return defaults for required fields

Use Dublin Core metadata elements (title, creator, language, publisher) per EPUB 3.3 specification.
  </action>
  <verify>Write test file with mock epubInfo object, verify extractMetadata returns correct structure with defaults for missing fields</verify>
  <done>extractMetadata() returns EpubMetadata object with title, author, optional language and publisher, uses defaults when metadata is missing</done>
</task>

<task type="auto">
  <name>Task 3: Implement text extraction and word counting</name>
  <files>src/epub/text.ts</files>
  <action>
Create src/epub/text.ts with:

1. Export function extractText(sections: any[]): string
   - Iterate through epubObj.sections array
   - For each section, call section.toMarkdown() to get markdown content
   - Extract textContent from markdown result
   - Concatenate all section text with newlines
   - Return combined text string

2. Export function countWords(text: string): number
   - Remove HTML tags using regex: text.replace(/<[^>]*>/g, ' ')
   - Split by whitespace: plainText.split(/\s+/)
   - Filter empty strings: word.length > 0
   - Filter for actual words: /[a-zA-Z0-9\u4e00-\u9fff]/.test(word) (includes CJK characters)
   - Return count of filtered words

Use Pattern 4 from RESEARCH.md as reference for word counting.

Key: Use section.toMarkdown() instead of manual HTML parsing to avoid Pitfall 2 (HTML tag contamination).
  </action>
  <verify>Run countWords() with sample text — should return accurate count, HTML tags should not be counted as words, CJK characters should be counted</verify>
  <done>extractText() concatenates text from all EPUB sections, countWords() returns accurate word count excluding HTML tags and including CJK characters</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. All TypeScript files compile without errors
2. @gxl/epub-parser imports resolve correctly
3. Type definitions for EpubParseResult and EpubMetadata are properly exported
4. Word counting function handles edge cases (multiple spaces, HTML tags, CJK characters)
</verification>

<success_criteria>
1. parseEpubFile() successfully parses EPUB files
2. extractMetadata() returns EpubMetadata with title, author, language, publisher
3. extractText() extracts readable text from all EPUB sections
4. countWords() returns accurate word counts excluding HTML tags
5. All functions have proper TypeScript types exported
</success_criteria>

<output>
After completion, create `.planning/phases/01-epub-foundation/01-02-SUMMARY.md`
</output>
