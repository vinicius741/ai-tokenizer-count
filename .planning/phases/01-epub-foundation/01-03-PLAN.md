---
phase: 01-epub-foundation
plan: 03
type: execute
wave: 2
depends_on: [01-01, 01-02]
files_modified:
  - src/cli/index.ts
  - src/output/table.ts
autonomous: true

must_haves:
  truths:
    - "User can run `epub-counter` command (after build)"
    - "User sees help text when running `epub-counter --help`"
    - "User can specify input files/folders as positional arguments"
    - "User can specify input path via --input flag"
    - "User can enable verbose output with --verbose / -v flag"
    - "User can enable recursive scanning with --recursive / -r flag"
    - "User can specify custom output folder path via --output / -o flag (CLI-05)"
    - "Default input is ./epubs/ when no arguments provided"
    - "Default output is ./results/ when --output not provided (CFG-02)"
    - "Tool displays results in formatted table with columns: filename, word count, title, author"
  artifacts:
    - path: "src/cli/index.ts"
      provides: "CLI entry point with commander"
      contains: "Command() setup, argument parsing, action handler, --output option"
    - path: "src/output/table.ts"
      provides: "cli-table3 wrapper"
      exports: ["displayResults", "TableOptions"]
  key_links:
    - from: "src/cli/index.ts"
      to: "commander"
      via: "Command class for CLI parsing"
      pattern: "new Command\\(\\)|\\.program\\(\\)"
    - from: "src/cli/index.ts"
      to: "src/file-discovery/scanner.ts"
      via: "Import discoverEpubFiles function"
      pattern: "import.*discoverEpubFiles"
    - from: "src/cli/index.ts"
      to: "src/epub/parser.ts, metadata.ts, text.ts"
      via: "Import parsing functions"
      pattern: "import.*parseEpubFile|extractMetadata|countWords"
    - from: "src/output/table.ts"
      to: "cli-table3"
      via: "Import Table from cli-table3"
      pattern: "import.*Table.*from.*cli-table3"
    - from: "src/cli/index.ts"
      to: "src/output/markdown.ts, src/output/json.ts"
      via: "Pass options.output to writeResultsFile() and writeJsonFile()"
      pattern: "writeResultsFile\\(.*options\\.output|writeJsonFile\\(.*options\\.output"
---

<objective>
Build the CLI interface using commander for argument parsing and cli-table3 for formatted table output display. Add --output flag to support custom output folder paths (CLI-05).

Purpose: Provide users with a command-line interface that accepts EPUB files or folders, processes them, displays results in a readable table format, and allows custom output folder specification.

Output: Working CLI with argument parsing, help text, table output display, and --output flag support (no error handling yet — that's Plan 04).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-epub-foundation/01-CONTEXT.md
@.planning/phases/01-epub-foundation/01-RESEARCH.md
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CLI interface with commander and --output flag</name>
  <files>src/cli/index.ts</files>
  <action>
Update src/cli/index.ts with full CLI implementation:

1. Import dependencies:
   - Command from 'commander'
   - discoverEpubFiles from '../file-discovery/scanner.js'
   - parseEpubFile from '../epub/parser.js'
   - extractMetadata from '../epub/metadata.js'
   - extractText, countWords from '../epub/text.js'
   - displayResults from '../output/table.js'
   - fs/promises for file operations

2. Create main async function processEpubs(inputPaths: string[], options: any)
   - Default to ['./epubs/'] if no paths provided
   - For each path in inputPaths:
     - Call discoverEpubFiles(path, { recursive: options.recursive, includeHidden: false })
     - Collect all discovered EPUB files
   - For each EPUB file:
     - Parse: parseEpubFile(filePath)
     - Extract metadata: extractMetadata(result.info)
     - Extract text: extractText(result.sections)
     - Count words: countWords(text)
     - Store result object with filename, wordCount, title, author
   - Call displayResults(results) to show table

3. Setup Commander program:
   - name: 'epub-counter'
   - description: 'Count words in EPUB files'
   - version: '1.0.0'
   - argument('[paths...]', 'Input files or folders (default: ./epubs/)')
   - option('-i, --input <path>', 'Input folder or file path')
   - option('-v, --verbose', 'Enable verbose output')
   - option('-r, --recursive', 'Scan subdirectories recursively')
   - option('-o, --output <path>', 'Output folder path (default: ./results/)')  # CLI-05 requirement
   - action((paths, options) => { handle input vs --input precedence, call processEpubs with options.output })

4. Handle input precedence:
   - If --input provided, use only that
   - Else if paths provided (positional), use those
   - Else use default ./epubs/

5. Handle output path:
   - If --output provided, store in options.output for passing to output functions
   - Else default to './results/' (will be used in Plan 04 writeResultsFile/writeJsonFile calls)

6. Call program.parse() at end

Use Pattern 2 from RESEARCH.md as reference.

DO NOT implement error handling in this task — errors will crash the process (Plan 04 adds continue-on-error).
  </action>
  <verify>Run `npm run build && node dist/cli/index.js --help` — should display help text with all options including --output / -o flag</verify>
  <done>CLI accepts positional paths, --input flag, --output flag, shows help text, defaults to ./epubs/ input, defaults to ./results/ output, supports --verbose and --recursive flags</done>
</task>

<task type="auto">
  <name>Task 2: Implement table output with cli-table3</name>
  <files>src/output/table.ts</files>
  <action>
Create src/output/table.ts with:

1. Export interface EpubResult:
   - filename: string
   - wordCount: number
   - title: string
   - author: string

2. Export interface TableOptions:
   - verbose: boolean (for future extensibility)

3. Export function displayResults(results: EpubResult[], options?: TableOptions): void
   - Create new Table with configuration:
     - head: ['Filename', 'Words', 'Title', 'Author']
     - colWidths: [30, 10, 40, 25] (sensible defaults from RESEARCH.md)
     - wordWrap: true (handle long content)
     - style: { head: ['cyan', 'bold'], border: ['grey'] }
   - For each result, push row: [filename, wordCount.toString(), title, author]
   - Log table.toString() to console

4. Handle empty results array — display "No EPUB files found" message

Use CLI Table Output pattern from RESEARCH.md as reference.
  </action>
  <verify>Run CLI with sample EPUB data — should display formatted table with proper column alignment and word wrapping</verify>
  <done>displayResults() renders table with 4 columns, proper alignment, word wrapping for long content, handles empty results gracefully</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` compiles without errors
2. `node dist/cli/index.js --help` displays help text with --output option
3. CLI accepts all documented arguments and flags including --output / -o
4. Table displays with proper formatting when run with EPUB files
</verification>

<success_criteria>
1. CLI executable via `node dist/cli/index.js`
2. Help text displays all options (--input, --verbose, --recursive, --output)
3. Positional arguments work for file/folder paths
4. Default behavior (no args) processes ./epubs/
5. Results display in formatted 4-column table
6. --output flag is available for custom output folder path (CLI-05)
</success_criteria>

<output>
After completion, create `.planning/phases/01-epub-foundation/01-03-SUMMARY.md`
</output>
